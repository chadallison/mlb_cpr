---
output: github_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "README.md", envir = globalenv()) })
---

___

```{r message = F, warning = F, include = F}
library(tidyverse)
library(tvthemes)
library(baseballr)
library(retrosheet)

theme_custom = theme_avatar() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = 2.5, face = "italic"),
        plot.caption = element_text(face = "italic"),
        panel.grid.major = element_line(linewidth = 0.5, colour = "#DFDAD1"),
        panel.grid.minor = element_line(linewidth = 0.5, colour = "#DFDAD1"))

theme_set(theme_custom)

better_date = function(date) {
  return(paste0(month(date, label = T, abbr = F), " ", day(date), ", ", year(date)))
}

sys_time = substr(Sys.time(), 12, 19)
```

**Data: MLB.com via {baseballr}** | Last Updated: `r better_date(Sys.Date())` at `r sys_time`

___

# Contents

- [Team Rankings]
- [Runs Scored v Runs Allowed]
- [Composite Performance Rating  (CPR) Rankings]
- [Records x CPR Ranks]
- [Scorigami (2023 Only)]
- [Historic MLB Scorigami (Since 1901)]
- [Top Team Analysis]
- [Team Margins Plot]
- [Scatterplot of Margins of Victory and Defeat]
- [Margins of Victory and Defeat]
- [One-Run Games]
- [Yesterday's Highest-Scoring Game]
- [Best Records This Month]
- [Runs Scored v Runs Allowed This Month]
- [Sudden Death Records]
- [Eras Records]
- [First Inning Runs Scored v Allowed]
- [First Inning Runs Scored v Allowed Rates]
- [First Inning Scoring]
- [Home and Away Performance]
- [Monthly v Season Win Percentages]
- [Win Percentage v Run Differential as Percent of Runs Scored]
- [Runs Scored in Wins and Losses]
- [Win Percentage by Home Runs]
- [Win Percentage by Strikeouts]
- [Home Runs by Strikeouts]
- [Home Runs in Wins and Losses]
- [When are teams scoring?]
- [Pythagorean Wins]
- [Close Games]

```{r include = F}
asg_dates = seq.Date(from = as_date("2023-07-10"), to = as_date("2023-07-13"), by = 1)
loop_dates = seq.Date(from = as_date("2023-03-30"), to = Sys.Date() - 1, by = 1)
loop_dates = loop_dates[!loop_dates %in% asg_dates]
end_games = data.frame(date = NULL, away_team = NULL, away_score = NULL, home_score = NULL, home_team = NULL)

for (i in 1:length(loop_dates)) {
  loop_df = mlb_game_pks(date = loop_dates[i]) |>
    mutate(date = loop_dates[i]) |>
    select(date, away_team = teams.away.team.name, away_score = teams.away.score,
           home_score = teams.home.score, home_team = teams.home.team.name)
  
  end_games = rbind(end_games, loop_df)
}

end_games = na.omit(end_games)
```

```{r include = F}
all_teams = sort(unique(end_games$home_team))

get_team_rspg = function(team) {
  home_scores = end_games |> filter(home_team == team) |> pull(home_score)
  away_scores = end_games |> filter(away_team == team) |> pull(away_score)
  return(round(mean(c(home_scores, away_scores)), 3))
}

get_team_rapg = function(team) {
  home_scores = end_games |> filter(home_team == team) |> pull(away_score)
  away_scores = end_games |> filter(away_team == team) |> pull(home_score)
  return(round(mean(c(home_scores, away_scores)), 3))
}

rpg_df = data.frame(team = all_teams) |>
  mutate(rspg = sapply(team, get_team_rspg),
         rapg = sapply(team, get_team_rapg))
```

```{r include = F}
team_abbrevs = data.frame(team = all_teams,
                          abb = c("ARI", "ATL", "BAL", "BOS", "CHC", "CHW",
                                  "CIN", "CLE", "COL", "DET", "HOU", "KC",
                                  "LAA", "LAD", "MIA", "MIL", "MIN", "NYM",
                                  "NYY", "OAK", "PHI", "PIT", "SD", "SF",
                                  "SEA", "STL", "TB", "TEX", "TOR", "WAS"))

team_color_codes = c("#A71930", "#CE1141", "#DF4601", "#BD3039", "#0E3386",
                     "#27251F", "#C6011F", "#00385D", "#333366", "#0C2340",
                     "#EB6E1F", "#004687", "#BA0021", "#005A9C", "#00A3E0",
                     "#FFC52F", "#D31145", "#FF5910", "#003087", "#003831",
                     "#E81828", "#FDB827", "#FFC425", "#FD5A1E", "#005C5C",
                     "#C41E3A", "#8FBCE6", "#C0111F", "#134A8E", "#FFB7C5")

team_colors = data.frame(team = all_teams, hex = team_color_codes)

team_divisions = data.frame(team = all_teams,
                            division = c("NL West", "NL East", "AL East", "AL East", "NL Central",
                                         "AL Central", "NL Central", "AL Central", "NL West", "AL Central",
                                         "AL West", "AL Central", "AL West", "NL West", "NL East",
                                         "NL Central", "AL Central", "NL East", "AL East", "AL West",
                                         "NL East", "NL Central", "NL West", "NL West", "AL West",
                                         "NL Central", "NL East", "AL West", "AL East", "NL East"))
```

### Team Rankings

```{r echo = F}
wl_df = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team))

team_records = wl_df |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  left_join(count(wl_df, lose_team), by = c("team" = "lose_team")) |>
  rename(losses = n) |>
  mutate(pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(desc(pct))

team_records |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.7)) +
  labs(x = NULL, y = "Win Percentage", title = "2023 MLB Rankings",
       subtitle = "Sorted by Highest to Lowest Win Percentage") +
  theme(axis.text.x = element_blank())
```

### Runs Scored v Runs Allowed

```{r echo = F}
rpg_df = rpg_df |>
  mutate(diff = rspg - rapg) |>
  inner_join(team_records |>
  select(team, pct), by = "team")

rs_cor = round(cor(rpg_df$pct, rpg_df$rspg), 3)
ra_cor = round(cor(rpg_df$pct, rpg_df$rapg), 3)

rpg_df |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(rspg, rapg)) +
  geom_point(aes(col = team), size = 5, show.legend = F) +
  geom_vline(xintercept = mean(rpg_df$rspg), linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = mean(rpg_df$rapg), linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  scale_x_continuous(breaks = seq(0, 10, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 10, by = 0.25)) +
  labs(x = "Runs Scored Per Game", y = "Runs Allowed Per Game",
       title = "Runs Scored v. Runs Allowed in 2023",
       subtitle = paste0("Correlation with Win Percentage: Runs Scored = ", rs_cor,
                         " | Runs Allowed = ", ra_cor))
```

```{r include = F}
end_extended = end_games |>
  left_join(rpg_df, by = c("home_team" = "team")) |>
  rename(home_rspg = rspg, home_rapg = rapg) |>
  left_join(rpg_df, by = c("away_team" = "team")) |>
  rename(away_rspg = rspg, away_rapg = rapg) |>
  mutate(home_exp = round((home_rspg + away_rapg) / 2, 3),
         away_exp = round((away_rspg + home_rapg) / 2, 3),
         home_off_cpr = home_score - home_exp,
         home_def_cpr = away_exp - away_score,
         away_off_cpr = away_score - away_exp,
         away_def_cpr = home_exp - home_score)
```

```{r include = F}
get_off_cpr = function(team) {
  home_cpr = end_extended |> filter(home_team == team) |> pull(home_off_cpr)
  away_cpr = end_extended |> filter(away_team == team) |> pull(away_off_cpr)
  return(round(mean(c(home_cpr, away_cpr)), 3))
}

get_def_cpr = function(team) {
  home_cpr = end_extended |> filter(home_team == team) |> pull(home_def_cpr)
  away_cpr = end_extended |> filter(away_team == team) |> pull(away_def_cpr)
  return(round(mean(c(home_cpr, away_cpr)), 3))
}

team_cpr = data.frame(team = all_teams) |>
  mutate(off_cpr = sapply(team, get_off_cpr),
         def_cpr = sapply(team, get_def_cpr),
         total_cpr = off_cpr + def_cpr)
```

### Composite Performance Rating  (CPR) Rankings

```{r echo = F}
day_label = paste(day(Sys.Date()), month(Sys.Date(), label = T, abbr = F)[1], year(Sys.Date()))

team_cpr |>
  mutate(pos_lab = ifelse(total_cpr > 0, round(total_cpr, 3), ""),
         neg_lab = ifelse(total_cpr < 0, round(total_cpr, 3), "")) |>
  ggplot(aes(reorder(team, total_cpr), total_cpr)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 2.5, hjust = -0.25) +
  geom_text(aes(label = neg_lab), size = 2.5, hjust = 1.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(-1.75, 1.75)) +
  labs(x = NULL, y = "Composite Performance Rating", title = paste0("MLB CPR Rankings as of ", day_label))
```

```{r include = F}
end_wl = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team))

team_wins = end_wl |>
  count(win_team) |>
  rename(team = win_team, wins = n)

team_losses = end_wl |>
  count(lose_team) |>
  rename(team = lose_team, losses = n)

team_records = team_wins |>
  left_join(team_losses, by = "team") |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses))
```

### Records x CPR Ranks

```{r echo = F}
team_records |>
  select(team, win_pct) |>
  left_join(team_cpr, by = "team") |>
  select(team, win_pct, total_cpr) |>
  mutate(record_rank = rank(-win_pct, ties.method = "average"),
         cpr_rank = rank(-total_cpr, ties.method = "average"),
         xxx = case_when(cpr_rank > record_rank ~ "Not as Good as Record",
                         cpr_rank < record_rank ~ "Better Than Record",
                         cpr_rank == record_rank ~ "Accurate Record")) |>
  ggplot(aes(cpr_rank, record_rank)) +
  geom_point(aes(col = xxx), size = 3) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  ggrepel::geom_text_repel(aes(label = team), size = 3, alpha = 0.25) +
  scale_color_manual(values = c("black", "springgreen4", "indianred3")) +
  labs(x = "CPR Rank", y = "Record Rank", col = NULL,
       title = "2023 MLB Records x CPR Ranks")
```

### Scorigami (2023 Only)

```{r echo = F}
gami_df = end_games |>
  transmute(date, win_team = ifelse(home_score > away_score, home_team, away_team),
            lose_team = ifelse(home_score > away_score, away_team, home_team),
            win_score = ifelse(home_score > away_score, home_score, away_score),
            lose_score = ifelse(home_score > away_score, away_score, home_score))

score_counts = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  count(win_score, lose_score) |>
  mutate(final_score = paste0(win_score, "-", lose_score))

most_recent = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score")) |>
  filter(n == 1) |>
  slice_max(date, n = 1)

# THE MOST RECENT DATA ABOVE HAS THE GAME BY GAME DATA

last_gami = paste0("Last Scorigami: ", most_recent$win_team, " def. ", most_recent$lose_team, " ",
                   most_recent$win_score, "-", most_recent$lose_score, " on ", most_recent$date)

yesterday_gami = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score")) |>
  filter(n == 1 & date == Sys.Date() - 1) |>
  nrow()

yesterday_text = case_when(yesterday_gami == 0 ~ "No Scorigami Yesterday :(",
                           yesterday_gami == 1 ~ "One Scorigami Yesterday :)",
                           yesterday_gami > 1 ~ paste0(yesterday_gami, " Scorigamis Yesterday :)"))

gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score),
         final_score = paste0(win_score, "-", lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score", "final_score")) |>
  mutate(win_score = as.numeric(as.character(win_score)),
         lose_score = as.numeric(as.character(lose_score))) |>
  distinct(win_score, lose_score, n) |>
  ggplot(aes(win_score, lose_score)) +
  geom_point(shape = "square", size = 7, aes(col = n), show.legend = F) +
  geom_text(aes(label = n), size = 3) +
  scale_color_gradient(high = "#5B7E54", low = "#97BA90") +
  scale_x_continuous(breaks = 0:30) +
  scale_y_continuous(breaks = 0:30) +
  labs(x = "Winning Score", y = "Losing Score", subtitle = last_gami,
       title = paste0("2023 MLB Scorigami: ", yesterday_text))
```

### Historic MLB Scorigami (Since 1901)

```{r echo = F}
# all_retro_teams = get_retrosheet(type = "game", year = 2022) |>
#   pull(HmTm) |> unique() |> sort()
# 
# retro_abbr_matches = data.frame(all_retro_teams) |>
#   mutate(new_team = c("LAA", "ARI", "ATL", "BAL", "BOS", "CHC", "CHW", "CIN", "CLE", "COL",
#                       "DET", "HOU", "KC", "LAD", "MIA", "MIL", "MIN", "NYM", "NYY", "OAK",
#                       "PHI", "PIT", "SD", "SEA", "SF", "STL", "TB", "TEX", "TOR", "WAS"))

# big_ole_results = data.frame(year = NULL, win_score = NULL, lose_score = NULL)
# 
# for (i in 1901:2022) {
#   fdf = get_retrosheet(type = "game", year = i) |>
#     select(HmRuns, VisRuns) |>
#     transmute(year = i, win_score = ifelse(HmRuns > VisRuns, HmRuns, VisRuns),
#               lose_score = ifelse(HmRuns > VisRuns, VisRuns, HmRuns))
#   
#   big_ole_results = rbind(big_ole_results, fdf)
# }

big_ole_results = read_csv("historic_results.csv", col_types = cols())

this_year_res = end_games |>
  transmute(year = 2023, win_score = ifelse(home_score > away_score, home_score, away_score),
            lose_score = ifelse(home_score > away_score, away_score, home_score))

big_ole_results = rbind(big_ole_results, this_year_res)

big_ole_results |>
  count(win_score, lose_score) |>
  arrange(desc(n)) |>
  ggplot(aes(win_score, lose_score)) +
  geom_point(shape = "square", size = 4, aes(col = n), show.legend = F) +
  scale_color_gradient(high = "#5B7E54", low = "#97BA90") +
  scale_x_continuous(breaks = 0:50) + scale_y_continuous(breaks = 0:50) +
  labs(x = "Winning Score", y = "Losing Score", title = "Historic MLB Scorigami (Since 1901)")
```

### Top Team Analysis

```{r echo = F}
wbt_df = end_games |>
  mutate(home_win = ifelse(home_score > away_score, 1, 0),
         home_wb2 = ifelse(home_score > away_score + 1, 1, 0),
         home_wb3 = ifelse(home_score > away_score + 2, 1, 0),
         home_wb4 = ifelse(home_score > away_score + 3, 1, 0),
         home_wb5 = ifelse(home_score > away_score + 4, 1, 0),
         away_win = ifelse(away_score > home_score, 1, 0),
         away_wb2 = ifelse(away_score > home_score + 1, 1, 0),
         away_wb3 = ifelse(away_score > home_score + 2, 1, 0),
         away_wb4 = ifelse(away_score > home_score + 3, 1, 0),
         away_wb5 = ifelse(away_score > home_score + 4, 1, 0))

get_wb2_rate = function(team) {
  home_wb2 = wbt_df |> filter(home_team == team) |> pull(home_wb2)
  away_wb2 = wbt_df |> filter(away_team == team) |> pull(away_wb2)
  return(round(mean(c(home_wb2, away_wb2)), 3))
}

get_wb3_rate = function(team) {
  home_wb3 = wbt_df |> filter(home_team == team) |> pull(home_wb3)
  away_wb3 = wbt_df |> filter(away_team == team) |> pull(away_wb3)
  return(round(mean(c(home_wb3, away_wb3)), 3))
}

get_wb4_rate = function(team) {
  home_wb4 = wbt_df |> filter(home_team == team) |> pull(home_wb4)
  away_wb4 = wbt_df |> filter(away_team == team) |> pull(away_wb4)
  return(round(mean(c(home_wb4, away_wb4)), 3))
}

get_wb5_rate = function(team) {
  home_wb5 = wbt_df |> filter(home_team == team) |> pull(home_wb5)
  away_wb5 = wbt_df |> filter(away_team == team) |> pull(away_wb5)
  return(round(mean(c(home_wb5, away_wb5)), 3))
}

best_record_teams = team_records |>
  slice_max(win_pct, n = 3, with_ties = F) |>
  pull(team)

team_wbt = data.frame(team = best_record_teams) |>
  left_join(select(team_records, team, win_pct), by = "team") |>
  mutate(wb2 = sapply(team, get_wb2_rate),
         wb3 = sapply(team, get_wb3_rate),
         wb4 = sapply(team, get_wb4_rate),
         wb5 = sapply(team, get_wb5_rate))

vis_df = team_wbt |>
  pivot_longer(cols = !team, names_to = "metric", values_to = "value") |>
  mutate(metric = case_when(metric == "win_pct" ~ "Win Percentage",
                            metric == "wb2" ~ "Win by 2+ Rate",
                            metric == "wb3" ~ "Win by 3+ Rate",
                            metric == "wb4" ~ "Win by 4+ Rate",
                            metric == "wb5" ~ "Win by 5+ Rate"),
         metric = factor(metric, levels = c("Win Percentage", "Win by 2+ Rate", "Win by 3+ Rate",
                                            "Win by 4+ Rate", "Win by 5+ Rate")),
         val_lab = paste0(value * 100, "%"))

rec_teams = sort(unique(vis_df$team))
max_colors = c(team_color_codes[which(team_colors$team == rec_teams[1])],
               team_color_codes[which(team_colors$team == rec_teams[2])],
               team_color_codes[which(team_colors$team == rec_teams[3])])

vis_df |>
  ggplot(aes(metric, value)) +
  geom_col(aes(fill = team), position = "dodge") +
  geom_text(aes(label = val_lab, group = team), size = 3, vjust = -0.5, position = position_dodge2(width = 0.9)) +
  scale_fill_manual(values = max_colors) +
  labs(x = NULL, y = "Rate", fill = NULL, title = "Top Team Win Rates",
       subtitle = "Top Three Teams by Win Percentage Included") +
  theme(axis.text.y = element_blank())
```

### Team Margins Plot

```{r echo = F}
end_margins = end_games |>
  mutate(home_margin = home_score - away_score,
         away_margin = away_score - home_score)

get_margin = function(team) {
  home_margins = pull(filter(end_margins, home_team == team), home_margin)
  away_margins = pull(filter(end_margins, away_team == team), away_margin)
  return(round(mean(c(home_margins, away_margins)), 3))
}

team_margins = data.frame(team = all_teams) |>
  mutate(margin = sapply(team, get_margin))

team_margins |>
  mutate(pos_lab = ifelse(margin >= 0, margin, ""),
         neg_lab = ifelse(margin < 0, margin, "")) |>
  ggplot(aes(reorder(team, margin), margin)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 2.5, hjust = -0.25) +
  geom_text(aes(label = neg_lab), size = 2.5, hjust = 1.25) +
  coord_flip(ylim = c(-3.25, 3.25)) +
  scale_fill_manual(values = team_color_codes) +
  labs(y = "Average Margin", x = NULL, title = "Average Margins by Team")
```

```{r  include = F, echo = F}
end_winners = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(away_score > home_score, home_team, away_team),
         margin = abs(home_score - away_score))

get_vmargin = function(team) {
  wins = pull(filter(end_winners, win_team == team), margin)
  return(round(mean(wins), 3))
}

get_dmargin = function(team) {
  losses = pull(filter(end_winners, lose_team == team), margin)
  return(-round(mean(losses), 3))
}

team_margins = data.frame(team = all_teams) |>
  mutate(avg_margin = sapply(team, get_margin),
         win_margin = sapply(team, get_vmargin),
         def_margin = sapply(team, get_dmargin))
```

### Scatterplot of Margins of Victory and Defeat

```{r echo = F}
vmarg_mean = mean(team_margins$win_margin)
dmarg_mean = mean(team_margins$def_margin)

team_margins |>
  mutate(wl_diff = win_margin - def_margin) |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_margin, def_margin)) +
  geom_point(size = 4, aes(col = team), show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  geom_hline(yintercept = dmarg_mean, linetype = "dashed", alpha = 0.4) +
  geom_vline(xintercept = vmarg_mean, linetype = "dashed", alpha = 0.4) +
  scale_color_manual(values = team_color_codes) +
  labs(x = "Avg. Margin of Victory", y = "Avg. Margin of Defeat",
       title = "Scatterplot of Margins of Victory/Defeat",
       subtitle = "Dashed lines represent league averages") +
  annotate("text", x = 2.5, y = -5.1, label = "Win Small, Lose Big", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 4.75, y = -5.1, label = "Win Big, Lose Big", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 2.5, y = -2.1, label = "Win Small, Lose Small", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 4.75, y = -2.1, label = "Win Big, Lose Small", fontface = "italic", alpha = 0.5) +
  coord_cartesian(xlim = c(min(team_margins$win_margin) - 0.25, max(team_margins$win_margin) + 0.25),
                  ylim = c(min(team_margins$def_margin) - 0.75, max(team_margins$def_margin) + 0.75)) +
  scale_x_continuous(breaks = seq(-10, 10, by = 0.5)) + scale_y_continuous(breaks = seq(-10, 10, by = 0.5))
```

### Margins of Victory and Defeat

```{r echo = F}
team_margins |>
  mutate(marg_diff = abs(win_margin - def_margin)) |>
  ggplot() +
  geom_col(aes(reorder(team, marg_diff), win_margin, fill = team), show.legend = F) +
  geom_col(aes(reorder(team, marg_diff), def_margin, fill = team), show.legend = F, alpha = 0.75) +
  geom_text(aes(reorder(team, marg_diff), win_margin, label = round(win_margin, 2)), size = 2.5, hjust = -0.25) +
  geom_text(aes(reorder(team, marg_diff), def_margin, label = round(def_margin, 2)), size = 2.5, hjust = 1.25) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(min(team_margins$def_margin) - 0.25, max(team_margins$win_margin) + 0.25)) +
  labs(x = NULL, y = "← Avg. Margin of Defeat | Avg. Margin of Victory →",
       title = "Team Margins of Victory and Defeat", subtitle = "Ordered by Largest to Smallest Range") +
  theme(axis.text.x = element_blank())
```

### One-Run Games

```{r echo = F}
one_runs = end_games |>
  filter(abs(home_score - away_score) == 1) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         home_win = ifelse(win_team == home_team, 1, 0))

or_wins = rename(count(one_runs, win_team), wins = n)
or_losses = rename(count(one_runs, lose_team), losses = n)

or_df = left_join(or_wins, or_losses, by = c("win_team" = "lose_team")) |>
  mutate(gp = wins + losses,
         win_per = round(wins / gp, 3)) |>
  left_join(team_abbrevs, by = c("win_team" = "team"))

or_df |>
  ggplot(aes(gp, win_per)) +
  geom_point(aes(col = win_team), size = 4, show.legend = F) +
  scale_color_manual(values = team_color_codes) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  geom_hline(aes(yintercept = mean(or_df$win_per)), linetype = "dashed", alpha = 0.5) +
  geom_vline(aes(xintercept = mean(or_df$gp)), linetype = "dashed", alpha = 0.5) +
  labs(x = "One-Run Games Played", y = "Win Percentage in One-Run Games",
       title = "How are MLB teams performing in one-run games?")
```

### Yesterday's Highest-Scoring Game

```{r message = F, warning = F, echo = F}
last_game_date = end_games |> slice_max(date, n = 1) |> sample_n(1) |> pull(date)

get_date_pks = function(fdate) {
  df = mlb_game_pks(date = fdate) |>
    select(game_pk, date = officialDate, away_team = teams.away.team.name,
           home_team = teams.home.team.name) |>
    mutate(date = as_date(date))
  
  return(df)
}

# all_game_pks = data.frame(game_pk = NULL, date = NULL, away_team = NULL, home_team = NULL)
all_game_pks = read_csv("all_game_pks.csv", col_types = cols())
this_loop_dates = loop_dates[!loop_dates %in% all_game_pks$date]

for (i in 1:length(this_loop_dates)) {
  if (length(this_loop_dates) == 0) break
  df = get_date_pks(this_loop_dates[i])
  all_game_pks = rbind(all_game_pks, df)
}

write_csv(all_game_pks, "all_game_pks.csv")

max_home_team = end_games |>
  filter(date == Sys.Date() - 1) |>
  mutate(total_score = home_score + away_score) |>
  slice_max(total_score, n = 1, with_ties = F) |>
  pull(home_team)

max_pk = all_game_pks |>
  filter(date == Sys.Date() - 1 & home_team == max_home_team) |>
  head(1) |>
  pull(game_pk)

vis_df = mlb_pbp(game_pk = max_pk) |>
  filter(count.outs.end == 3) |>
  select(inning = about.inning, away_team, away_score = result.awayScore,
         home_score = result.homeScore, home_team) |>
  pivot_longer(c(home_score, away_score), names_to = "team", values_to = "score") |>
  mutate(team = ifelse(team == "home_score", home_team, away_team)) |>
  group_by(inning, team) |>
  slice_max(score, n = 1)

max_teams = sort(unique(vis_df$team))
max_colors = c(team_color_codes[which(team_colors$team == max_teams[1])],
               team_color_codes[which(team_colors$team == max_teams[2])])

high_df = end_games |>
  filter(date == Sys.Date() - 1) |>
  mutate(total_score = home_score + away_score,
         win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score)) |>
  slice_max(total_score, n = 1)

high_lab = paste0(high_df$win_team, " def. ", high_df$lose_team, " ",
                  high_df$win_score, "-", high_df$lose_score)

vis_df |>
  ggplot(aes(inning, score)) +
  geom_line(aes(col = team), linewidth = 2) +
  scale_x_continuous(breaks = 1:25) +
  scale_y_continuous(breaks = 1:25) +
  scale_color_manual(values = max_colors) +
  labs(x = "Inning", y = "Score", col = NULL, subtitle = high_lab,
       title = "Scoring Trends for Yesterday's Highest-Scoring Game")
```

### Best Records This Month

```{r echo = F}
this_month = as.character(month(Sys.Date() - 1, label = T, abbr = F))

this_month_end_games = end_games |>
  filter(month(date, label = T, abbr = F) == this_month) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score))

this_month_records = this_month_end_games |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  full_join(count(this_month_end_games, lose_team), by = c("team" = "lose_team")) |>
  rename(losses = n) |>
  mutate(wins = replace_na(wins, 0),
         losses = replace_na(losses, 0),
         pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(team)

this_month_records |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 1)) +
  labs(x = NULL, y = "Win Percentage", title = paste0("Best Records This Month (", this_month, ")")) +
  theme(axis.text.x = element_blank())
```

### Runs Scored v Runs Allowed This Month

```{r echo = F}
get_month_rspg = function(team) {
  home_scores = pull(filter(this_month_end_games, home_team == team), home_score)
  away_scores = pull(filter(this_month_end_games, away_team == team), away_score)
  return(sum(c(home_scores, away_scores)))
}

get_month_rapg = function(team) {
  home_scores = pull(filter(this_month_end_games, home_team == team), away_score)
  away_scores = pull(filter(this_month_end_games, away_team == team), home_score)
  return(sum(c(home_scores, away_scores)))
}

this_month_scored_allowed = data.frame(team = all_teams) |>
  mutate(scored = sapply(team, get_month_rspg),
         allowed = sapply(team, get_month_rapg),
         diff = scored - allowed)

get_n_games_month = function(team) {
  return(end_games |>
    filter(month(date, label = T, abbr = F) == this_month &
             (home_team == team | away_team == team)) |> nrow())
}

msas = this_month_scored_allowed |>
  mutate(n_games = sapply(team, get_n_games_month),
         rspg = scored / n_games, rapg = allowed / n_games) |>
  left_join(team_abbrevs, by = "team")

mean_s = mean(msas$rspg)
mean_a = mean(msas$rapg)

msas |>
  ggplot(aes(rspg, rapg)) +
  geom_point(aes(col = team), show.legend = F, size = 4) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  scale_color_manual(values = team_color_codes) +
  geom_vline(xintercept = mean_s, linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = mean_a, linetype = "dashed", alpha = 0.5) +
  labs(x = "Runs Scored Per Game", y = "Runs Allowed Per Game",
       title = paste0("Scatterplot of Runs Scored v. Runs Allowed This Month (", this_month, ")")) +
  scale_x_continuous(breaks = seq(0, 50, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 50, by = 0.25))
```

### Sudden Death Records

```{r message = F, warning = F, echo = F}
pks_with_scored_first = read_csv("first_score_winners.csv", col_types = cols())
bad_pks = c(718700, 718558, 718371, 717664, 717579)

who_scored_first = function(fpk) {
  return(mlb_pbp(fpk) |>
    filter(isPitch & about.isScoringPlay) |>
    mutate(startTime = as_datetime(startTime)) |>
    arrange(startTime) |>
    head(1) |>
    pull(batting_team))
}

new_first_scores = all_game_pks |>
  filter(!game_pk %in% bad_pks & date < Sys.Date() & !game_pk %in% pks_with_scored_first$game_pk) |>
  mutate(first_score = sapply(game_pk, who_scored_first))

pks_with_scored_first = rbind(pks_with_scored_first, new_first_scores)
write_csv(pks_with_scored_first, "first_score_winners.csv")

scored_first_records = pks_with_scored_first |>
  mutate(loser = ifelse(first_score == home_team, away_team, home_team)) |>
  count(loser) |>
  rename(team = loser, losses = n) |>
  left_join(pks_with_scored_first |>
  count(first_score) |>
  rename(team = first_score, wins = n), by = "team") |>
  select(team, wins, losses) |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses))

scored_first_records |>
  select(team, fs_pct = win_pct) |>
  left_join(team_records, by = "team") |>
  select(team, win_pct, fs_pct) |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_pct, fs_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  scale_color_manual(values = team_color_codes) +
  # geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  labs(x = "Win Percentage", y = "Win Percentage if First Score Won",
       title = "What if MLB games were sudden death?",
       subtitle = "Teams above/left of the dashed line would benefit") +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent)
```

### Eras Records

```{r echo = F}
eras_dates = as_date(c("2023-03-17", "2023-03-18",
                       "2023-03-24", "2023-03-25",
                       "2023-03-31", "2023-04-01", "2023-04-02",
                       "2023-04-13", "2023-04-14", "2023-04-15",
                       "2023-04-21", "2023-04-22", "2023-04-23",
                       "2023-04-28", "2023-04-29", "2023-04-30",
                       "2023-05-05", "2023-05-06", "2023-05-07",
                       "2023-05-12", "2023-05-13", "2023-05-14",
                       "2023-05-19", "2023-05-20", "2023-05-21",
                       "2023-05-26", "2023-05-27", "2023-05-28",
                       "2023-06-02", "2023-06-03", "2023-06-04",
                       "2023-06-09", "2023-06-10",
                       "2023-06-16", "2023-06-17",
                       "2023-06-23", "2023-06-24",
                       "2023-06-30", "2023-07-01",
                       "2023-07-07", "2023-07-08",
                       "2023-07-14", "2023-07-15",
                       "2023-07-22", "2023-07-23",
                       "2023-07-28", "2023-07-29",
                       "2023-08-03", "2023-08-04", "2023-08-05", "2023-08-06",
                       "2023-08-07", "2023-08-08", "2023-08-09"))

eras_res = end_games |>
  filter(date %in% eras_dates) |>
  mutate(winner = ifelse(home_score > away_score, home_team, away_team),
         loser = ifelse(home_score > away_score, away_team, home_team))

eras_res |>
  count(winner) |>
  rename(team = winner, wins = n) |>
  left_join(eras_res |>
  count(loser) |>
  rename(team = loser, losses = n), by = "team") |>
  mutate(pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.75)) +
  labs(x = NULL, y = "Win Percentage", title = "MLB Team Records on Eras Tour Dates",
       subtitle = "Which MLB team is the ultimate group of Swifties?") +
  theme(axis.text.x = element_blank())
```

### First Inning Runs Scored v Allowed

```{r message = F, warning = F, echo = F}
all_fir = read_csv("first_inning_runs.csv")

get_home_first_inning_runs = function(fpk) {
  return(mlb_pbp(fpk) |>
    filter(about.inning == 1 & !is.na(details.homeScore)) |>
    summarise(home_score = max(details.homeScore)) |>
    pull(home_score))
}

get_away_first_inning_runs = function(fpk) {
  return(mlb_pbp(fpk) |>
    filter(about.inning == 1 & !is.na(details.awayScore)) |>
    summarise(away_score = max(details.awayScore)) |>
    pull(away_score))
}

new_fir = all_game_pks |>
  filter(!game_pk %in% bad_pks & !game_pk %in% all_fir$game_pk & date == Sys.Date() - 1) |>
  mutate(home_fir = sapply(game_pk, get_home_first_inning_runs),
         away_fir = sapply(game_pk, get_away_first_inning_runs))

all_fir = rbind(all_fir, new_fir)
write_csv(all_fir, "first_inning_runs.csv")

get_total_fir = function(team) {
  home_fir = all_fir |> filter(home_team == team) |> pull(home_fir)
  away_fir = all_fir |> filter(away_team == team) |> pull(away_fir)
  return(sum(c(home_fir, away_fir)))
}

get_total_fira = function(team) {
  home_fir = all_fir |> filter(home_team == team) |> pull(away_fir)
  away_fir = all_fir |> filter(away_team == team) |> pull(home_fir)
  return(sum(c(home_fir, away_fir)))
}

get_fir_rate = function(team) {
  home_fir = all_fir |> filter(home_team == team) |> mutate(fir = ifelse(home_fir > 0, 1, 0)) |> pull(fir)
  away_fir = all_fir |> filter(away_team == team) |> mutate(fir = ifelse(away_fir > 0, 1, 0)) |> pull(fir)
  return(round(mean(c(home_fir, away_fir)), 3))
}

get_fira_rate = function(team) {
  home_fir = all_fir |> filter(home_team == team) |> mutate(fir = ifelse(away_fir > 0, 1, 0)) |> pull(fir)
  away_fir = all_fir |> filter(away_team == team) |> mutate(fir = ifelse(home_fir > 0, 1, 0)) |> pull(fir)
  return(round(mean(c(home_fir, away_fir)), 3))
}

team_fir_metrics = data.frame(team = all_teams) |>
  mutate(total_fir = sapply(team, get_total_fir),
         total_fira = sapply(team, get_total_fira),
         fir_rate = sapply(team, get_fir_rate),
         fira_rate = sapply(team, get_fira_rate))

team_fir_metrics |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(total_fir, total_fira)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  scale_color_manual(values = team_color_codes) +
  geom_hline(aes(yintercept = mean(team_fir_metrics$total_fira)), linetype = "dashed", alpha = 0.5) +
  geom_vline(aes(xintercept = mean(team_fir_metrics$total_fir)), linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 100, by = 5)) +
  scale_y_continuous(breaks = seq(0, 100, by = 5)) +
  labs(x = "Total First Inning Runs Scored", y = "Total First Inning Runs Allowed",
       title = "First Inning Runs Scored v. Allowed")

ydaypk = all_game_pks |>
  filter(date == Sys.Date() - 1) |>
  pull(game_pk)
```

### First Inning Runs Scored v Allowed Rates

```{r echo = F}
team_fir_metrics |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(fir_rate, fira_rate)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  scale_color_manual(values = team_color_codes) +
  geom_hline(aes(yintercept = mean(team_fir_metrics$fira_rate)), linetype = "dashed", alpha = 0.5) +
  geom_vline(aes(xintercept = mean(team_fir_metrics$fir_rate)), linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.025), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.025), labels = scales::percent) +
  labs(x = "First Inning Score Rate", y = "First Inning Score Allowance Rate",
       title = "First Inning Runs Scored v. Allowed Rate")
```

### First Inning Scoring

```{r echo = F}
team_fir_metrics |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(fir_rate, total_fir)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.025), label = scales::percent) +
  scale_y_continuous(breaks = seq(0, 100, by = 5)) +
  labs(x = "First Inning Score Rate", y = "Total First Inning Runs Scored",
       title = "Which teams are scoring the most in the first inning?")
```

### Home and Away Performance

```{r echo = F}
end_wl = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         home_win = ifelse(home_score > away_score, 1, 0),
         home_loss = ifelse(home_score > away_score, 0, 1),
         away_win = ifelse(home_score > away_score, 0, 1),
         away_loss = ifelse(home_score > away_score, 1, 0))

home_away_records = end_wl |>
  group_by(team = home_team) |>
  summarise(wins = sum(home_win),
            losses = sum(home_loss)) |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(desc(win_pct)) |>
  select(team, home_win_pct = win_pct, home_record = record) |>
  left_join(end_wl |>
          group_by(team = away_team) |>
          summarise(wins = sum(away_win),
                    losses = sum(away_loss)) |>
          mutate(win_pct = round(wins / (wins + losses), 3),
                 record = paste0(wins, "-", losses)) |>
          arrange(desc(win_pct)) |>
          select(team, away_win_pct = win_pct, away_record = record), by = "team")

home_away_records |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(home_win_pct, away_win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  # geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  labs(x = "Home Win Percentage", y = "Away Win Percentage",
       title = "Scatterplot of Home and Away Win Percentages",
       subtitle = "Teams above dashed line perform better on the road")
```

### Monthly v Season Win Percentages

```{r echo = F}
team_records |>
  select(team, win_pct) |>
  inner_join(this_month_records |>
  select(team, month_pct = pct), by = "team") |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_pct, month_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  # geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  geom_hline(aes(yintercept = 0.5), alpha = 0.1) +
  geom_vline(aes(xintercept = 0.5), alpha = 0.1) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  scale_color_manual(values = team_color_codes) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  labs(x = "Season Win Percentage", y = paste0(this_month, " Win Percentage"),
       title = "Scatterplot of Overall and Monthly Win Percentages",
       subtitle = "Teams above dashed line are doing better this month")
```

### Win Percentage v Run Differential as Percent of Runs Scored

```{r echo = F}
get_runs_scored = function(team) {
  home = end_games |> filter(home_team == team) |> pull(home_score) |> sum()
  away = end_games |> filter(away_team == team) |> pull(away_score) |> sum()
  return(home + away)
}

get_runs_allowed = function(team) {
  home = end_games |> filter(home_team == team) |> pull(away_score) |> sum()
  away = end_games |> filter(away_team == team) |> pull(home_score) |> sum()
  return(home + away)
}

scored_allowed_df = data.frame(team = all_teams) |>
  mutate(scored = sapply(team, get_runs_scored),
         allowed = sapply(team, get_runs_allowed),
         diff = scored - allowed)

scored_allowed_df |>
  inner_join(team_records |>
  select(team, win_pct), by = "team") |>
  inner_join(team_abbrevs, by = "team") |>
  mutate(diff_pct = round(diff / scored, 3)) |>
  ggplot(aes(diff_pct, win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5, max.overlaps = 30) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_hline(aes(yintercept = 0.5), alpha = 0.1) +
  geom_vline(aes(xintercept = 0), alpha = 0.1) +
  scale_x_continuous(breaks = seq(-5, 5, by = 0.1), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  labs(x = "Run Differential as Percentage of Runs Scored", y = "Win Percentage",
       title = "Win Percentage v. Run Differential as Percent of Runs Scored",
       subtitle = "Teams above dashed line have a better record than they 'should'")
```

### Runs Scored in Wins and Losses

```{r echo = F}
# runs scored in wins and losses + runs allowed in wins and losses
end_wl = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         lose_score = ifelse(home_score > away_score, away_score, home_score))

# function to find games played
get_games_played = function(team) {
  return(end_wl |>
    filter(home_team == team | away_team == team) |>
    nrow())
}

# function to find runs scored in wins
get_win_scored = function(team) {
  return(end_wl |>
    filter(win_team == team) |>
    pull(win_score) |>
    sum() / get_games_played(team))
}

# function to find runs allowed in wins
get_win_allowed = function(team) {
  return(end_wl |>
    filter(win_team == team) |>
    pull(lose_score) |>
    sum() / get_games_played(team))
}

# function to find runs scored in losses
get_loss_scored = function(team) {
  return(end_wl |>
    filter(lose_team == team) |>
    pull(lose_score) |>
    sum() / get_games_played(team))
}

# function to find runs allowed in losses
get_loss_allowed = function(team) {
  return(end_wl |>
    filter(lose_team == team) |>
    pull(win_score) |>
    sum() / get_games_played(team))
}

wl_sa = data.frame(team = all_teams) |>
  mutate(win_scored = sapply(team, get_win_scored),
         win_allowed = sapply(team, get_win_allowed),
         loss_scored = sapply(team, get_loss_scored),
         loss_allowed = sapply(team, get_loss_allowed)) |>
  mutate_if(is.numeric, ~round(., 3))

wl_sa |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_scored, loss_scored)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  labs(x = "Avg. Runs Scored in Wins", y = "Avg. Runs Scored in Losses",
       title = "Scatterplot of Runs Scored in Wins v. Losses",
       subtitle = "Teams above dashed line are scoring above-average runs in losses") +
  scale_x_continuous(breaks = seq(0, 10, by = 0.25)) +
  scale_y_continuous(breaks = seq(0, 5, by = 0.25))
```

### Win Percentage by Home Runs

```{r echo = F}
all_homers = read_csv("all_game_hrs.csv", col_types = cols())
# all_homers = data.frame(game_pk = NULL, team = NULL, hrs = NULL)

get_game_hrs = function(pk) {
  return(mlb_pbp(pk) |>
    filter(!is.na(hitData.hardness) & result.event == "Home Run") |>
    group_by(game_pk, team = batting_team) |>
    summarise(hrs = n(),
              .groups = "drop"))
}

pk_list = all_game_pks |>
  filter(date < Sys.Date() & !game_pk %in% bad_pks & !game_pk %in% all_homers$game_pk) |>
  pull(game_pk)

if (length(pk_list) > 0) {
  for (i in 1:length(pk_list)) {
    homers = get_game_hrs(pk_list[i])
    if (nrow(homers) == 0) homers = data.frame(game_pk = pk_list[i], team = "Chicago Cubs", hrs = 0)
    all_homers = rbind(all_homers, homers)
    # if (i %% 10 == 0) print(i)
  }
}

write_csv(all_homers, "all_game_hrs.csv")

cor_df = all_homers |>
  group_by(team) |>
  summarise(hrs = sum(hrs)) |>
  inner_join(team_records, by = "team") |>
  select(team, hrs, win_pct)

cor_lab = round(cor(cor_df$hrs, cor_df$win_pct), 3)

all_homers |>
  group_by(team) |>
  summarise(hrs = sum(hrs)) |>
  inner_join(team_records |>
  select(team, win_pct), by = "team") |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(hrs, win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5, max.overlaps = 30) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_hline(aes(yintercept = 0.5), alpha = 0.1) +
  labs(x = "Home Runs", y = "Win Percentage",
       title = "Win Percentage by Number of Home Runs",
       subtitle = paste0("Correlation: ", cor_lab)) +
  scale_x_continuous(breaks = seq(0, 500, by = 10)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent)
```

### Win Percentage by Strikeouts

```{r echo = F}
all_ks = read_csv("all_game_ks.csv", col_types = cols())
# all_ks = data.frame(game_pk = NULL, team = NULL, ks = NULL)

get_game_ks = function(pk) {
  return(mlb_pbp(pk) |>
    filter(result.event == "Strikeout" & details.isOut) |>
    group_by(game_pk, team = batting_team) |>
    summarise(ks = n(),
              .groups = "drop"))
}

pk_list = all_game_pks |>
  filter(date < Sys.Date() & !game_pk %in% bad_pks & !game_pk %in% all_ks$game_pk) |>
  pull(game_pk)

if (length(pk_list) > 0) {
  for (i in 1:length(pk_list)) {
    ks = get_game_ks(pk_list[i])
    if (nrow(ks) == 0) ks = data.frame(game_pk = pk_list[i], team = "Chicago Cubs", ks = 0)
    all_ks = rbind(all_ks, ks)
    if (i %% 25 == 0) print(i)
  }
}

write_csv(all_ks, "all_game_ks.csv")

cor_df = all_ks |>
  group_by(team) |>
  summarise(ks = sum(ks)) |>
  inner_join(team_records |>
  select(team, win_pct), by = "team")

cor_lab = round(cor(cor_df$ks, cor_df$win_pct), 3)

all_ks |>
  group_by(team) |>
  summarise(ks = sum(ks)) |>
  inner_join(team_records |>
  select(team, win_pct), by = "team") |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(ks, win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  labs(x = "Strikeouts", y = "Win Percentage",
       title = "Scatterplot of Strikeouts and Win Percentage by Team",
       subtitle = paste0("Correlation ", cor_lab)) +
  scale_x_continuous(breaks = seq(0, 2500, by = 25)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent)
```

### Home Runs by Strikeouts

```{r echo = F}
cor_df = all_ks |>
  group_by(team) |>
  summarise(ks = sum(ks)) |>
  inner_join(all_homers |>
  group_by(team) |>
  summarise(hrs = sum(hrs)), by = "team")

cor_lab = round(cor(cor_df$ks, cor_df$hrs), 3)

all_ks |>
  group_by(team) |>
  summarise(ks = sum(ks)) |>
  inner_join(all_homers |>
  group_by(team) |>
  summarise(hrs = sum(hrs)), by = "team") |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(hrs, ks)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  labs(x = "Home Runs", y = "Strikeouts",
       title = "Scatterplot of Home Runs and Strikeouts by Team",
       subtitle = paste0("Correlation: ", cor_lab)) +
  scale_x_continuous(breaks = seq(0, 500, by = 10)) +
  scale_y_continuous(breaks = seq(0, 2500, by = 50))
```

### Home Runs in Wins and Losses

```{r message = F, warning = F, echo = F}
get_team_wl_homers = function(f_team) {
  team_homers = all_homers |>
    filter(team == f_team) |>
    select(-team)
  
  win_homers = all_game_pks |>
    inner_join(end_games, by = c("date", "away_team", "home_team")) |>
    mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
           lose_team = ifelse(home_score > away_score, away_team, home_team)) |>
    filter(win_team == f_team) |>
    left_join(team_homers, by = "game_pk") |>
    summarise(homers = sum(hrs, na.rm = T),
              n = n())
  
  loss_homers = all_game_pks |>
    inner_join(end_games, by = c("date", "away_team", "home_team")) |>
    mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
           lose_team = ifelse(home_score > away_score, away_team, home_team)) |>
    filter(lose_team == f_team) |>
    left_join(team_homers, by = "game_pk") |>
    summarise(homers = sum(hrs, na.rm = T),
              n = n())
  
  win_hr = round(win_homers$homers / win_homers$n, 3)
  loss_hr = round(loss_homers$homers / loss_homers$n, 3)
  return(data.frame(team = f_team, win_hr = win_hr, loss_hr = loss_hr))
}

team_wl_homers = data.frame(team = NULL, win_hr = NULL, loss_hr = NULL)

for (i in 1:length(all_teams)) {
  team_wl_homers = rbind(team_wl_homers, get_team_wl_homers(all_teams[i]))
}

cor_lab = round(cor(team_wl_homers$win_hr, team_wl_homers$loss_hr), 3)

team_wl_homers |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_hr, loss_hr)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  labs(x = "Average HRs in Wins", y = "Average HRs in Losses",
       title = "Scatterplot of Average HRs in Wins and Losses by Team",
       subtitle = paste0("Correlation: ", cor_lab)) +
  scale_x_continuous(breaks = seq(0, 5, by = 0.1)) +
  scale_y_continuous(breaks = seq(0, 5, by = 0.1))
```

### When are teams scoring?

```{r message = F, warning = F, echo = F}
runs_scored_thirds = read_csv("runs_scored_thirds.csv", col_types = cols())

full_pks = all_game_pks |>
  filter(date < Sys.Date() & !game_pk %in% bad_pks) |>
  pull(game_pk)

full_pks = full_pks[!full_pks %in% runs_scored_thirds$game_pk]

# runs_scored_thirds = data.frame()
if (length(full_pks) > 0) {
  for (i in 1:length(full_pks)) {
    loop_data = mlb_pbp(full_pks[i]) |>
      mutate(game_third = case_when(about.inning <= 3 ~ "Innings 1-3",
                                    about.inning >= 4 & about.inning <= 6 ~ "Innings 4-6",
                                    about.inning >= 7 ~ "Innings 7+"),
             game_date = as_date(game_date)) |>
      distinct(game_pk, date = game_date, about.inning,
               result = result.description, game_third, batting_team) |>
      filter(str_detect(result, "scores") | str_detect(result, "homers")) |>
      mutate(runs = str_count(result, "scores") + str_count(result, "homers")) |>
      group_by(game_pk, date, batting_team, game_third) |>
      summarise(runs = sum(runs),
                .groups = "drop")
    
    runs_scored_thirds = rbind(runs_scored_thirds, loop_data)
    if (i %% 25 == 0) print(paste0(round(i / length(full_pks) * 100, 2), "%"))
  }
}

write_csv(runs_scored_thirds, "runs_scored_thirds.csv")

runs_scored_thirds |>
  group_by(batting_team, game_third) |>
  summarise(runs = sum(runs),
            .groups = "drop") |>
  group_by(batting_team) |>
  mutate(pct = round(runs / sum(runs), 3)) |>
  inner_join(team_abbrevs, by = c("batting_team" = "team")) |>
  ggplot(aes(game_third, pct)) +
  geom_point(aes(col = batting_team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5, alpha = 0.25, max.overlaps = 30) +
  scale_color_manual(values = team_color_codes) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.02), labels = scales::percent) +
  labs(x = NULL, y = "Percent of Total Runs Scored",
       title = "When are teams scoring their runs?")

# runs_scored_thirds |>
#   mutate(start_finish = ifelse(game_third == "Innings 7+", "finish", "start")) |>
#   group_by(batting_team, start_finish) |>
#   summarise(runs = sum(runs),
#             .groups = "drop") |>
#   pivot_wider(batting_team, names_from = "start_finish", values_from = "runs") |>
#   inner_join(team_abbrevs, by = c("batting_team" = "team")) |>
#   ggplot(aes(start, finish)) +
#   geom_point(aes(col = batting_team), size = 4, show.legend = F) +
#   ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
#   scale_color_manual(values = team_color_codes) +
#   geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
#   labs(x = "Runs before 7th inning", y = "Runs in 7th inning or later",
#        title = "Who is scoring more runs at the end of the game?")
```


### Which teams play the closest games?

```{r echo = F}
game_diffs = end_games |>
  mutate(diff = abs(home_score - away_score))

get_avg_diff = function(team) {
  home_diff = game_diffs |> filter(home_team == team) |> pull(diff)
  away_diff = game_diffs |> filter(away_team == team) |> pull(diff)
  return(round(mean(c(home_diff, away_diff)), 3))
}

data.frame(team = all_teams) |>
  mutate(avg_diff = sapply(team, get_avg_diff)) |>
  ggplot(aes(reorder(team, avg_diff), avg_diff)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = avg_diff), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 4.5)) +
  labs(x = NULL, y = "Average Run Differential",
       title = "On average, which team's games are closest?") +
  theme(axis.text.x = element_blank())

# data.frame(team = all_teams) |>
#   mutate(avg_diff = sapply(team, get_avg_diff)) |>
#   inner_join(team_records |>
#   select(team, win_pct), by = "team") |>
#   inner_join(team_abbrevs, by = "team") |>
#   ggplot(aes(avg_diff, win_pct)) +
#   geom_point(aes(col = team), size = 4, show.legend = F) +
#   ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
#   scale_color_manual(values = team_color_codes) +
#   geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
#   labs(x = "Average Run Differential", y = "Win Percentage",
#        title = "Scatterplot of Win Percentage by Average Run Differential")
```

### Pythagorean Wins

```{r echo = F}
get_pythag_wins = function(team) {
  home_scored = end_games |> filter(home_team == team) |> pull(home_score)
  away_scored = end_games |> filter(away_team == team) |> pull(away_score)
  home_allow = end_games |> filter(home_team == team) |> pull(away_score)
  away_allow = end_games |> filter(away_team == team) |> pull(home_score)
  scored = sum(home_scored) + sum(away_scored)
  allowed = sum(home_allow) + sum(away_allow)
  x = scored ^ 2 / (scored ^ 2 + allowed ^ 2)
  return(round(x, 3))
}

team_records |>
  select(team, win_pct) |>
  mutate(py_wins = sapply(team, get_pythag_wins)) |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(py_wins, win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  scale_color_manual(values = team_color_codes) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5) +
  labs(x = "Pythagorean Win Percentage", y = "Actual Win Percentage",
       title = "Win Percentage by Pythagorean Wins",
       subtitle = "Teams above the dashed line have better records than they 'should'") +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent)

# team_records |>
#   select(team, win_pct) |>
#   mutate(py_wins = sapply(team, get_pythag_wins),
#          diff = py_wins - win_pct) |>
#   arrange(desc(diff))
```

```{r echo = F}
cor_df = data.frame(team = all_teams) |>
  mutate(scored = sapply(team, get_runs_scored),
         allowed = sapply(team, get_runs_allowed),
         diff = scored - allowed,
         pythag = sapply(team, get_pythag_wins),
         adj_margin = round(diff / scored, 3)) |>
  select(team, pythag, adj_margin) |>
  inner_join(team_records |>
  select(team, win_pct), by = "team")

adj_margin = round(cor(cor_df$adj_margin, cor_df$win_pct), 3)
pythag = round(cor(cor_df$pythag, cor_df$win_pct), 3)

if (adj_margin > pythag) {
  print(paste0("Run-adjusted margin is more correlated than pythagorean wins (", adj_margin, " vs. ", pythag, ")"))
} else {
  print(paste0("Pythagorean wins is more correlated than run-adjusted margin (", pythag, " vs. ", adj_margin, ")"))
}

cor_df |>
  inner_join(team_abbrevs, by = "team") |>
  ggplot(aes(adj_margin, win_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 3.5, max.overlaps = 30) +
  scale_color_manual(values = team_color_codes) +
  geom_line(stat = "smooth", formula = y ~ x, method = "lm", linetype = "dashed", alpha = 0.5) +
  geom_hline(aes(yintercept = 0.5), linetype = "dotted", alpha = 0.25) +
  geom_vline(aes(xintercept = 0), linetype = "dotted", alpha = 0.25) +
  labs(x = "Run-Adjusted Margin", y = "Win Percentage",
       title = "Win Percentage by Run-Adjusted Margin",
       subtitle = "Run-Adjusted Margin = Run Differential / Runs Scored") +
  scale_x_continuous(breaks = seq(-1, 1, by = 0.1)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent)
```

```{r include = F}
get_run_adj_margin = function(team) {
  scored = get_runs_scored(team)
  allowed = get_runs_allowed(team)
  diff = scored - allowed
  adj = round(diff / scored, 3)
  return(adj)
}

team_ram = data.frame(team = all_teams) |>
  mutate(RAM = sapply(team, get_run_adj_margin)) |>
  arrange(desc(RAM))

ram_res = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team)) |>
  inner_join(team_ram, by = c("home_team" = "team")) |>
  rename(home_RAM = RAM) |>
  inner_join(team_ram, by = c("away_team" = "team")) |>
  rename(away_RAM = RAM) |>
  mutate(RAM_win = ifelse(home_RAM > away_RAM, home_team, away_team)) |>
  count(win_team == RAM_win) |>
  pull(n)

paste0("RAM-only game prediction accuracy: ", round(ram_res[2] / sum(ram_res), 4) * 100, "%")
```

### Close Games

```{r echo = F}
runs_threshold = 3

close_df = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         diff = abs(home_score - away_score)) |>
  filter(diff <= runs_threshold) |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  inner_join(end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         diff = abs(home_score - away_score)) |>
  filter(diff <= runs_threshold) |>
  count(lose_team) |>
  rename(team = lose_team, losses = n), by = "team") |>
  transmute(team,
            gp = wins + losses,
            record = paste0(wins, "-", losses),
            win_pct = round(wins / (wins + losses), 3))

if (runs_threshold == 1) {
  close_df |>
    mutate(team2 = paste0(team, " (", gp, ")")) |>
    ggplot(aes(reorder(team2, win_pct), win_pct)) +
    geom_col(aes(fill = team), show.legend = F) +
    scale_fill_manual(values = team_color_codes) +
    coord_flip(ylim = c(0, max(close_df$win_pct) * 1.1)) +
    geom_text(aes(label = record), size = 3, hjust = -0.25) +
    scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
    labs(x = NULL, y = "Win Percentage",
         title = "MLB Standings in One-Run Games")
} else {
  close_df |>
    mutate(team2 = paste0(team, " (", gp, ")")) |>
    ggplot(aes(reorder(team2, win_pct), win_pct)) +
    geom_col(aes(fill = team), show.legend = F) +
    scale_fill_manual(values = team_color_codes) +
    coord_flip(ylim = c(0, max(close_df$win_pct) * 1.1)) +
    geom_text(aes(label = record), size = 3, hjust = -0.25) +
    scale_y_continuous(breaks = seq(0, 1, by = 0.05), labels = scales::percent) +
    labs(x = NULL, y = "Win Percentage",
         title = paste0("MLB Standings in Games Decided by ", runs_threshold, " or Less"))
}
```

### Monthly Win Trends

```{r echo = F}
monthly_winners = end_games |>
  filter(month(date) != 3) |>
  transmute(month = month(date, label = T, abbr = F),
            win_team = ifelse(home_score > away_score, home_team, away_team))

monthly_winners |>
  group_by(month) |>
  count(win_team) |>
  rename(team = win_team, month_wins = n) |>
  inner_join(monthly_winners |>
  count(win_team) |>
  rename(team = win_team, wins = n), by = "team") |>
  mutate(month_pct = month_wins / wins) |>
  ggplot(aes(month, month_pct)) +
  geom_line(aes(col = team, group = team), linewidth = 1.5, show.legend = F) +
  scale_color_manual(values = team_color_codes) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.025), labels = scales::percent) +
  facet_wrap(vars(team))
```

### Monthly Scoring Trends

```{r echo = F}
get_team_monthly_runs = function(team) {
  return(end_games |>
    filter(home_team == team | away_team == team) |>
    mutate(team_score = ifelse(home_team == team, home_score, away_score),
           opp_score = ifelse(home_team == team, away_score, home_score),
           month = month(date, label = T, abbr = T),
           team = team) |>
    group_by(team, month) |>
    summarise(team_runs = sum(team_score),
              opp_runs = sum(opp_score),
              .groups = "drop"))
}

monthly_runs = data.frame()

for (i in 1:length(all_teams)) {
  data = get_team_monthly_runs(all_teams[i])
  monthly_runs = rbind(monthly_runs, data)
}

monthly_runs |>
  mutate(total_runs = team_runs + opp_runs,
         pct = team_runs / total_runs) |>
  filter(month != "Mar") |>
  ggplot(aes(month, pct)) +
  geom_line(aes(col = team, group = team), linewidth = 2, show.legend = F) +
  geom_hline(yintercept = 0.5, linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.1), labels = scales::percent) +
  facet_wrap(vars(team)) +
  labs(x = NULL, y = "Runs Scored / (Runs Scored + Runs Allowed)",
       title = "Monthly Scoring Trends")
```

### Best Team of Past Month?

```{r message = F, warning = F}
# getting vector of all team names
all_teams = mlb_teams(season = 2023) |>
  filter(sport_name == "Major League Baseball") |>
  pull(team_full_name) |>
  sort()

# getting end game data and adding info
end_games = mlb_schedule(season = 2023, level_ids = "1") |>
  filter(teams_away_team_name %in% all_teams &
           teams_home_team_name %in% all_teams &
           series_description == "Regular Season" &
           status_detailed_state == "Final") |>
  select(date, game_pk,
         away_team = teams_away_team_name, away_score = teams_away_score,
         home_score = teams_home_score, home_team = teams_home_team_name) |>
  mutate(date = as_date(date),
         win_team = ifelse(home_score > away_score, home_team, away_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         final_score = paste0(win_score, "-", lose_score),
         description = paste0(win_team, " def. ", lose_team, " ", final_score))

# best records of the past month
# end_games |>
#   filter(date >= Sys.Date() - 31) |>
#   count(win_team) |>
#   rename(team = win_team, wins = n) |>
#   inner_join(end_games |>
#   filter(date >= Sys.Date() - 31) |>
#   count(lose_team) |>
#   rename(team = lose_team, losses = n), by = "team") |>
#   mutate(win_pct = round(wins / (wins + losses), 3)) |>
#   arrange(desc(win_pct))

# function to get runs scored in past month
get_past_month_runs_scored = function(team) {
  home_runs = end_games |> filter(date >= Sys.Date() - 31 & home_team == team) |> pull(home_score) |> sum()
  away_runs = end_games |> filter(date >= Sys.Date() - 31 & away_team == team) |> pull(away_score) |> sum()
  return(home_runs + away_runs)
}

# function to get runs allowed in past month
get_past_month_runs_allowed = function(team) {
  home_runs = end_games |> filter(date >= Sys.Date() - 31 & home_team == team) |> pull(away_score) |> sum()
  away_runs = end_games |> filter(date >= Sys.Date() - 31 & away_team == team) |> pull(home_score) |> sum()
  return(home_runs + away_runs)
}

# team color codes
team_color_codes = c("#A71930", "#CE1141", "#DF4601", "#BD3039", "#0E3386",
                     "#27251F", "#C6011F", "#00385D", "#333366", "#0C2340",
                     "#EB6E1F", "#004687", "#BA0021", "#005A9C", "#00A3E0",
                     "#FFC52F", "#D31145", "#FF5910", "#003087", "#003831",
                     "#E81828", "#FDB827", "#FFC425", "#FD5A1E", "#005C5C",
                     "#C41E3A", "#8FBCE6", "#C0111F", "#134A8E", "#FFB7C5")

# getting run-adjusted margins for each team in past month
past_month_ram = data.frame(team = all_teams) |>
  mutate(scored = sapply(team, get_past_month_runs_scored),
         allowed = sapply(team, get_past_month_runs_allowed),
         diff = scored - allowed,
         ram = round(diff / scored, 3),
         pos_lab = ifelse(ram >= 0, ram, ""),
         neg_lab = ifelse(ram < 0, ram, ""))

past_month_ram |>
  ggplot(aes(reorder(team, ram), ram)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 3, hjust = -0.25) +
  geom_text(aes(label = neg_lab), size = 3, hjust = 1.25) +
  annotate("text", x = 1.5, y = 0.25, label = "Data: MLB.com via {baseballr}", size = 3, fontface = "italic") +
  scale_fill_manual(values = team_color_codes) +
  scale_y_continuous(breaks = seq(-3, 3, by = 0.1)) +
  coord_flip(ylim = c(min(past_month_ram$ram) * 1.1, max(past_month_ram$ram) * 1.1)) +
  labs(x = NULL, y = "RAM",
       title = "Past Month Run-Adjusted Margin (RAM)",
       subtitle = "RAM = (Runs Scored - Runs Allowed) / Runs Scored")
```


```{r message = F, warning = F}
margin_results = end_games |>
  mutate(win_margin = win_score - lose_score,
         margin_description = paste0(win_team, " win by ", win_margin),
         loser_desc = paste0(lose_team, " lose by ", win_margin)) |>
  count(margin_description) |>
  mutate(desc = paste0(margin_description, " (", n, ")")) |>
  arrange(desc(n), margin_description) |>
  pull(desc)

margin_results_L = end_games |>
  mutate(win_margin = win_score - lose_score,
         margin_description = paste0(win_team, " win by ", win_margin),
         loser_desc = paste0(lose_team, " lose by ", win_margin)) |>
  count(loser_desc) |>
  mutate(desc = paste0(loser_desc, " (", n, ")")) |>
  arrange(desc(n), loser_desc) |>
  pull(desc)

upper_limit = 10

for (i in 1:upper_limit) {
  print(margin_results[i])
}

print("========================================")

for (i in 1:upper_limit) {
  print(margin_results_L[i])
}
```

```{r message = F, warning = F}
end_games |>
  mutate(diff = win_score - lose_score) |>
  filter(diff >= 3) |>
  count(win_team) |>
  arrange(desc(n)) |>
  rename(`Team` = win_team,
         `Wins by 3+` = n)
```

```{r message = F, warning = F}
reg23 = end_games |>
  mutate(total_score = home_score + away_score)

post22 = mlb_schedule(season = 2022, level_ids = "1") |>
  filter(teams_away_team_name %in% all_teams &
           teams_home_team_name %in% all_teams &
           series_description %in% c("Division Series", "League Championship Series", "Wild Card Game", "World Series") &
           status_detailed_state == "Final") |>
  select(date, game_pk,
         away_team = teams_away_team_name, away_score = teams_away_score,
         home_score = teams_home_score, home_team = teams_home_team_name) |>
  mutate(date = as_date(date),
         win_team = ifelse(home_score > away_score, home_team, away_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         final_score = paste0(win_score, "-", lose_score),
         description = paste0(win_team, " def. ", lose_team, " ", final_score),
         total_score = home_score + away_score)
```

```{r message = F, warning = F}
# most postseason games had six or less runs scored
# post22 |>
#   count(total_score <= 6)

reg23 |>
  filter(total_score <= 6) |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  inner_join(reg23 |>
  filter(total_score <= 6) |>
  count(lose_team) |>
  rename(team = lose_team, losses = n), by = "team") |>
  mutate(win_pct = round(wins / (wins + losses), 3)) |>
  arrange(desc(win_pct))
```







