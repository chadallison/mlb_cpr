---
output: github_document
knit: (function(input, ...) { rmarkdown::render(input, output_file = "README.md", envir = globalenv()) })
---

___

**Data: MLB.com via {baseballr}**

# Contents

- [Team Rankings]
- [Runs Scored v Runs Allowed]
- [Composite Performance Rating  (CPR) Rankings]
- [Records x CPR Ranks]
- [Scorigami (2023 Only)]
- [Historic MLB Scorigami (Since 1901)]
- [Top Team Analysis]
- [Team Margins Plot]
- [Scatterplot of Margins of Victory and Defeat]
- [Margins of Victory and Defeat]
- [One-Run Games]
- [Yesterday's Highest-Scoring Game]
- [Best Records This Month]
- [Runs Scored This Month]
- [Runs Allowed This Month]
- [Best Home Records]
- [Best Away Records]
- [Runs Scored v Runs Allowed This Month]
- [What if Games Were Decided by Hits?]
- [What if Games Were Decided by Total Bases?]
- [Sudden Death Records]
- [Eras Records]

```{r message = F, warning = F, include = F}
library(tidyverse)
library(tidymodels)
library(tvthemes)
library(janitor)
library(patchwork)
library(baseballr)
library(retrosheet)

theme_custom = theme_avatar() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 9, vjust = 2.5, face = "italic"),
        plot.caption = element_text(face = "italic"),
        panel.grid.major = element_line(linewidth = 0.5, colour = "#D6D0C4"),
        panel.grid.minor = element_line(linewidth = 0.5, colour = "#D6D0C4"))

theme_set(theme_custom)
```

```{r include = F}
asg_dates = seq.Date(from = as_date("2023-07-10"), to = as_date("2023-07-13"), by = 1)
loop_dates = seq.Date(from = as_date("2023-03-30"), to = Sys.Date() - 1, by = 1)
loop_dates = loop_dates[!loop_dates %in% asg_dates]
end_games = data.frame(date = NULL, away_team = NULL, away_score = NULL, home_score = NULL, home_team = NULL)

for (i in 1:length(loop_dates)) {
  loop_df = mlb_game_pks(date = loop_dates[i]) |>
    mutate(date = loop_dates[i]) |>
    select(date, away_team = teams.away.team.name, away_score = teams.away.score,
           home_score = teams.home.score, home_team = teams.home.team.name)
  
  end_games = rbind(end_games, loop_df)
}

end_games = na.omit(end_games)
```

```{r include = F}
all_teams = sort(unique(end_games$home_team))

get_team_rspg = function(team) {
  home_scores = end_games |> filter(home_team == team) |> pull(home_score)
  away_scores = end_games |> filter(away_team == team) |> pull(away_score)
  return(round(mean(c(home_scores, away_scores)), 3))
}

get_team_rapg = function(team) {
  home_scores = end_games |> filter(home_team == team) |> pull(away_score)
  away_scores = end_games |> filter(away_team == team) |> pull(home_score)
  return(round(mean(c(home_scores, away_scores)), 3))
}

rpg_df = data.frame(team = all_teams) |>
  mutate(rspg = sapply(team, get_team_rspg),
         rapg = sapply(team, get_team_rapg))
```

```{r include = F}
team_abbrevs = data.frame(team = all_teams,
                          abb = c("ARI", "ATL", "BAL", "BOS", "CHC", "CHW",
                                  "CIN", "CLE", "COL", "DET", "HOU", "KC",
                                  "LAA", "LAD", "MIA", "MIL", "MIN", "NYM",
                                  "NYY", "OAK", "PHI", "PIT", "SD", "SF",
                                  "SEA", "STL", "TB", "TEX", "TOR", "WAS"))

team_color_codes = c("#A71930", "#CE1141", "#DF4601", "#BD3039", "#0E3386",
                     "#27251F", "#C6011F", "#00385D", "#333366", "#0C2340",
                     "#EB6E1F", "#004687", "#BA0021", "#005A9C", "#00A3E0",
                     "#FFC52F", "#D31145", "#FF5910", "#003087", "#003831",
                     "#E81828", "#FDB827", "#FFC425", "#FD5A1E", "#005C5C",
                     "#C41E3A", "#8FBCE6", "#C0111F", "#134A8E", "#FFB7C5")

team_colors = data.frame(team = all_teams, hex = team_color_codes)

team_divisions = data.frame(team = all_teams,
                            division = c("NL West", "NL East", "AL East", "AL East", "NL Central",
                                         "AL Central", "NL Central", "AL Central", "NL West", "AL Central",
                                         "AL West", "AL Central", "AL West", "NL West", "NL East",
                                         "NL Central", "AL Central", "NL East", "AL East", "AL West",
                                         "NL East", "NL Central", "NL West", "NL West", "AL West",
                                         "NL Central", "NL East", "AL West", "AL East", "NL East"))
```

### Team Rankings

```{r echo = F}
wl_df = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team))

team_records = wl_df |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  left_join(count(wl_df, lose_team), by = c("team" = "lose_team")) |>
  rename(losses = n) |>
  mutate(pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(desc(pct))

team_records |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.7)) +
  labs(x = NULL, y = "Win Percentage", title = "2023 MLB Rankings",
       subtitle = "Sorted by Highest to Lowest Win Percentage") +
  theme(axis.text.x = element_blank())
```

### Runs Scored v Runs Allowed

```{r echo = F}
rpg_df = rpg_df |>
  mutate(diff = rspg - rapg)

top_teams = rpg_df |>
  slice_max(diff, n = 3) |>
  pull(team)

bottom_teams = rpg_df |>
  slice_min(diff, n = 3) |>
  pull(team)

rpg_df |>
  left_join(team_abbrevs, by = "team") |>
  mutate(top_lab = ifelse(team %in% top_teams, abb, ""),
         bot_lab = ifelse(team %in% bottom_teams, abb, ""),
         other_lab = ifelse(!team %in% top_teams & !team %in% bottom_teams, abb, "")) |>
  ggplot(aes(rspg, rapg)) +
  geom_point(aes(col = team), size = 5, show.legend = F) +
  geom_vline(xintercept = mean(rpg_df$rspg), linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = mean(rpg_df$rapg), linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  ggrepel::geom_text_repel(aes(label = top_lab), size = 3.5) +
  ggrepel::geom_text_repel(aes(label = bot_lab), size = 3.5) +
  ggrepel::geom_text_repel(aes(label = other_lab), size = 3.5, alpha = 0.25, max.overlaps = 30) +
  labs(x = "Runs Scored Per Game", y = "Runs Allowed Per Game",
       title = "Runs Scored v. Runs Allowed in 2023")
```

```{r include = F}
end_extended = end_games |>
  left_join(rpg_df, by = c("home_team" = "team")) |>
  rename(home_rspg = rspg, home_rapg = rapg) |>
  left_join(rpg_df, by = c("away_team" = "team")) |>
  rename(away_rspg = rspg, away_rapg = rapg) |>
  mutate(home_exp = round((home_rspg + away_rapg) / 2, 3),
         away_exp = round((away_rspg + home_rapg) / 2, 3),
         home_off_cpr = home_score - home_exp,
         home_def_cpr = away_exp - away_score,
         away_off_cpr = away_score - away_exp,
         away_def_cpr = home_exp - home_score)
```

```{r include = F}
get_off_cpr = function(team) {
  home_cpr = end_extended |> filter(home_team == team) |> pull(home_off_cpr)
  away_cpr = end_extended |> filter(away_team == team) |> pull(away_off_cpr)
  return(round(mean(c(home_cpr, away_cpr)), 3))
}

get_def_cpr = function(team) {
  home_cpr = end_extended |> filter(home_team == team) |> pull(home_def_cpr)
  away_cpr = end_extended |> filter(away_team == team) |> pull(away_def_cpr)
  return(round(mean(c(home_cpr, away_cpr)), 3))
}

team_cpr = data.frame(team = all_teams) |>
  mutate(off_cpr = sapply(team, get_off_cpr),
         def_cpr = sapply(team, get_def_cpr),
         total_cpr = off_cpr + def_cpr)
```

### Composite Performance Rating  (CPR) Rankings

```{r echo = F}
day_label = paste(day(Sys.Date()), month(Sys.Date(), label = T, abbr = F)[1], year(Sys.Date()))

team_cpr |>
  mutate(pos_lab = ifelse(total_cpr > 0, round(total_cpr, 3), ""),
         neg_lab = ifelse(total_cpr < 0, round(total_cpr, 3), "")) |>
  ggplot(aes(reorder(team, total_cpr), total_cpr)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 2.5, hjust = -0.25) +
  geom_text(aes(label = neg_lab), size = 2.5, hjust = 1.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(-1.75, 1.75)) +
  labs(x = NULL, y = "Composite Performance Rating", title = paste0("MLB CPR Rankings as of ", day_label))
```

```{r include = F}
end_wl = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team))

team_wins = end_wl |>
  count(win_team) |>
  rename(team = win_team, wins = n)

team_losses = end_wl |>
  count(lose_team) |>
  rename(team = lose_team, losses = n)

team_records = team_wins |>
  left_join(team_losses, by = "team") |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses))
```

### Records x CPR Ranks

```{r echo = F}
team_records |>
  select(team, win_pct) |>
  left_join(team_cpr, by = "team") |>
  select(team, win_pct, total_cpr) |>
  mutate(record_rank = rank(-win_pct, ties.method = "average"),
         cpr_rank = rank(-total_cpr, ties.method = "average"),
         xxx = case_when(cpr_rank > record_rank ~ "Not as Good as Record",
                         cpr_rank < record_rank ~ "Better Than Record",
                         cpr_rank == record_rank ~ "Accurate Record")) |>
  ggplot(aes(cpr_rank, record_rank)) +
  geom_point(aes(col = xxx), size = 3) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  ggrepel::geom_text_repel(aes(label = team), size = 3, alpha = 0.25) +
  scale_color_manual(values = c("black", "springgreen4", "indianred3")) +
  labs(x = "CPR Rank", y = "Record Rank", col = NULL,
       title = "2023 MLB Records x CPR Ranks")
```

### Scorigami (2023 Only)

```{r echo = F}
gami_df = end_games |>
  transmute(date, win_team = ifelse(home_score > away_score, home_team, away_team),
            lose_team = ifelse(home_score > away_score, away_team, home_team),
            win_score = ifelse(home_score > away_score, home_score, away_score),
            lose_score = ifelse(home_score > away_score, away_score, home_score))

score_counts = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  count(win_score, lose_score) |>
  mutate(final_score = paste0(win_score, "-", lose_score))

most_recent = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score")) |>
  filter(n == 1) |>
  slice_max(date, n = 1)

# THE MOST RECENT DATA ABOVE HAS THE GAME BY GAME DATA

last_gami = paste0("Last Scorigami: ", most_recent$win_team, " def. ", most_recent$lose_team, " ",
                   most_recent$win_score, "-", most_recent$lose_score, " on ", most_recent$date)

yesterday_gami = gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score")) |>
  filter(n == 1 & date == Sys.Date() - 1) |>
  nrow()

yesterday_text = case_when(yesterday_gami == 0 ~ "No Scorigami Yesterday :(",
                           yesterday_gami == 1 ~ "One Scorigami Yesterday :)",
                           yesterday_gami > 1 ~ paste0(yesterday_gami, " Scorigamis Yesterday :)"))

gami_df |>
  mutate(win_score = factor(win_score),
         lose_score = factor(lose_score),
         final_score = paste0(win_score, "-", lose_score)) |>
  left_join(score_counts, by = c("win_score", "lose_score", "final_score")) |>
  mutate(win_score = as.numeric(as.character(win_score)),
         lose_score = as.numeric(as.character(lose_score))) |>
  distinct(win_score, lose_score, n) |>
  ggplot(aes(win_score, lose_score)) +
  geom_point(shape = "square", size = 7, aes(col = n), show.legend = F) +
  geom_text(aes(label = n), size = 3) +
  scale_color_gradient(high = "#5B7E54", low = "#97BA90") +
  scale_x_continuous(breaks = 0:30) +
  scale_y_continuous(breaks = 0:30) +
  labs(x = "Winning Score", y = "Losing Score", subtitle = last_gami,
       title = paste0("2023 MLB Scorigami: ", yesterday_text))
```

### Historic MLB Scorigami (Since 1901)

```{r echo = F}
# all_retro_teams = get_retrosheet(type = "game", year = 2022) |>
#   pull(HmTm) |> unique() |> sort()
# 
# retro_abbr_matches = data.frame(all_retro_teams) |>
#   mutate(new_team = c("LAA", "ARI", "ATL", "BAL", "BOS", "CHC", "CHW", "CIN", "CLE", "COL",
#                       "DET", "HOU", "KC", "LAD", "MIA", "MIL", "MIN", "NYM", "NYY", "OAK",
#                       "PHI", "PIT", "SD", "SEA", "SF", "STL", "TB", "TEX", "TOR", "WAS"))

# big_ole_results = data.frame(year = NULL, win_score = NULL, lose_score = NULL)
# 
# for (i in 1901:2022) {
#   fdf = get_retrosheet(type = "game", year = i) |>
#     select(HmRuns, VisRuns) |>
#     transmute(year = i, win_score = ifelse(HmRuns > VisRuns, HmRuns, VisRuns),
#               lose_score = ifelse(HmRuns > VisRuns, VisRuns, HmRuns))
#   
#   big_ole_results = rbind(big_ole_results, fdf)
# }

big_ole_results = read_csv("historic_results.csv", col_types = cols())

this_year_res = end_games |>
  transmute(year = 2023, win_score = ifelse(home_score > away_score, home_score, away_score),
            lose_score = ifelse(home_score > away_score, away_score, home_score))

big_ole_results = rbind(big_ole_results, this_year_res)

big_ole_results |>
  count(win_score, lose_score) |>
  arrange(desc(n)) |>
  ggplot(aes(win_score, lose_score)) +
  geom_point(shape = "square", size = 4, aes(col = n), show.legend = F) +
  scale_color_gradient(high = "#5B7E54", low = "#97BA90") +
  scale_x_continuous(breaks = 0:50) + scale_y_continuous(breaks = 0:50) +
  labs(x = "Winning Score", y = "Losing Score", title = "Historic MLB Scorigami (Since 1901)")
```

### Top Team Analysis

```{r echo = F}
wbt_df = end_games |>
  mutate(home_win = ifelse(home_score > away_score, 1, 0),
         home_wb2 = ifelse(home_score > away_score + 1, 1, 0),
         home_wb3 = ifelse(home_score > away_score + 2, 1, 0),
         home_wb4 = ifelse(home_score > away_score + 3, 1, 0),
         home_wb5 = ifelse(home_score > away_score + 4, 1, 0),
         away_win = ifelse(away_score > home_score, 1, 0),
         away_wb2 = ifelse(away_score > home_score + 1, 1, 0),
         away_wb3 = ifelse(away_score > home_score + 2, 1, 0),
         away_wb4 = ifelse(away_score > home_score + 3, 1, 0),
         away_wb5 = ifelse(away_score > home_score + 4, 1, 0))

get_wb2_rate = function(team) {
  home_wb2 = wbt_df |> filter(home_team == team) |> pull(home_wb2)
  away_wb2 = wbt_df |> filter(away_team == team) |> pull(away_wb2)
  return(round(mean(c(home_wb2, away_wb2)), 3))
}

get_wb3_rate = function(team) {
  home_wb3 = wbt_df |> filter(home_team == team) |> pull(home_wb3)
  away_wb3 = wbt_df |> filter(away_team == team) |> pull(away_wb3)
  return(round(mean(c(home_wb3, away_wb3)), 3))
}

get_wb4_rate = function(team) {
  home_wb4 = wbt_df |> filter(home_team == team) |> pull(home_wb4)
  away_wb4 = wbt_df |> filter(away_team == team) |> pull(away_wb4)
  return(round(mean(c(home_wb4, away_wb4)), 3))
}

get_wb5_rate = function(team) {
  home_wb5 = wbt_df |> filter(home_team == team) |> pull(home_wb5)
  away_wb5 = wbt_df |> filter(away_team == team) |> pull(away_wb5)
  return(round(mean(c(home_wb5, away_wb5)), 3))
}

best_record_teams = team_records |>
  slice_max(win_pct, n = 3, with_ties = F) |>
  pull(team)

team_wbt = data.frame(team = best_record_teams) |>
  left_join(select(team_records, team, win_pct), by = "team") |>
  mutate(wb2 = sapply(team, get_wb2_rate),
         wb3 = sapply(team, get_wb3_rate),
         wb4 = sapply(team, get_wb4_rate),
         wb5 = sapply(team, get_wb5_rate))

vis_df = team_wbt |>
  pivot_longer(cols = !team, names_to = "metric", values_to = "value") |>
  mutate(metric = case_when(metric == "win_pct" ~ "Win Percentage",
                            metric == "wb2" ~ "Win by 2+ Rate",
                            metric == "wb3" ~ "Win by 3+ Rate",
                            metric == "wb4" ~ "Win by 4+ Rate",
                            metric == "wb5" ~ "Win by 5+ Rate"),
         metric = factor(metric, levels = c("Win Percentage", "Win by 2+ Rate", "Win by 3+ Rate",
                                            "Win by 4+ Rate", "Win by 5+ Rate")),
         val_lab = paste0(value * 100, "%"))

rec_teams = sort(unique(vis_df$team))
max_colors = c(team_color_codes[which(team_colors$team == rec_teams[1])],
               team_color_codes[which(team_colors$team == rec_teams[2])],
               team_color_codes[which(team_colors$team == rec_teams[3])])

vis_df |>
  ggplot(aes(metric, value)) +
  geom_col(aes(fill = team), position = "dodge") +
  geom_text(aes(label = val_lab, group = team), size = 3, vjust = -0.5, position = position_dodge2(width = 0.9)) +
  scale_fill_manual(values = max_colors) +
  labs(x = NULL, y = "Rate", fill = NULL, title = "Top Team Win Rates",
       subtitle = "Top Three Teams by Win Percentage Included") +
  theme(axis.text.y = element_blank())
```

### Team Margins Plot

```{r echo = F}
end_margins = end_games |>
  mutate(home_margin = home_score - away_score,
         away_margin = away_score - home_score)

get_margin = function(team) {
  home_margins = pull(filter(end_margins, home_team == team), home_margin)
  away_margins = pull(filter(end_margins, away_team == team), away_margin)
  return(round(mean(c(home_margins, away_margins)), 3))
}

team_margins = data.frame(team = all_teams) |>
  mutate(margin = sapply(team, get_margin))

team_margins |>
  mutate(pos_lab = ifelse(margin >= 0, margin, ""),
         neg_lab = ifelse(margin < 0, margin, "")) |>
  ggplot(aes(reorder(team, margin), margin)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = pos_lab), size = 2.5, hjust = -0.25) +
  geom_text(aes(label = neg_lab), size = 2.5, hjust = 1.25) +
  coord_flip(ylim = c(-3.25, 3.25)) +
  scale_fill_manual(values = team_color_codes) +
  labs(y = "Average Margin", x = NULL, title = "Average Margins by Team")
```

```{r  include = F, echo = F}
end_winners = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(away_score > home_score, home_team, away_team),
         margin = abs(home_score - away_score))

get_vmargin = function(team) {
  wins = pull(filter(end_winners, win_team == team), margin)
  return(round(mean(wins), 3))
}

get_dmargin = function(team) {
  losses = pull(filter(end_winners, lose_team == team), margin)
  return(-round(mean(losses), 3))
}

team_margins = data.frame(team = all_teams) |>
  mutate(avg_margin = sapply(team, get_margin),
         win_margin = sapply(team, get_vmargin),
         def_margin = sapply(team, get_dmargin))
```

### Scatterplot of Margins of Victory and Defeat

```{r echo = F}
vmarg_mean = mean(team_margins$win_margin)
dmarg_mean = mean(team_margins$def_margin)

team_margins |>
  mutate(wl_diff = win_margin - def_margin) |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_margin, def_margin)) +
  geom_point(size = 4, aes(col = team), show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  geom_hline(yintercept = dmarg_mean, linetype = "dashed", alpha = 0.4) +
  geom_vline(xintercept = vmarg_mean, linetype = "dashed", alpha = 0.4) +
  scale_color_manual(values = team_color_codes) +
  labs(x = "Avg. Margin of Victory", y = "Avg. Margin of Defeat",
       title = "Scatterplot of Margins of Victory/Defeat",
       subtitle = "Dashed lines represent league averages") +
  annotate("text", x = 2.5, y = -5.1, label = "Win Small, Lose Big", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 5, y = -5.1, label = "Win Big, Lose Big", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 2.5, y = -2.1, label = "Win Small, Lose Small", fontface = "italic", alpha = 0.5) +
  annotate("text", x = 5, y = -2.1, label = "Win Big, Lose Small", fontface = "italic", alpha = 0.5) +
  coord_cartesian(xlim = c(min(team_margins$win_margin) - 0.25, max(team_margins$win_margin) + 0.25),
                  ylim = c(min(team_margins$def_margin) - 0.75, max(team_margins$def_margin) + 0.75)) +
  scale_x_continuous(breaks = seq(-10, 10, by = 0.5)) + scale_y_continuous(breaks = seq(-10, 10, by = 0.5))
```

### Margins of Victory and Defeat

```{r echo = F}
team_margins |>
  mutate(marg_diff = abs(win_margin - def_margin)) |>
  ggplot() +
  geom_col(aes(reorder(team, marg_diff), win_margin, fill = team), show.legend = F) +
  geom_col(aes(reorder(team, marg_diff), def_margin, fill = team), show.legend = F, alpha = 0.75) +
  geom_text(aes(reorder(team, marg_diff), win_margin, label = round(win_margin, 2)), size = 2.5, hjust = -0.25) +
  geom_text(aes(reorder(team, marg_diff), def_margin, label = round(def_margin, 2)), size = 2.5, hjust = 1.25) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(min(team_margins$def_margin) - 0.25, max(team_margins$win_margin) + 0.25)) +
  labs(x = NULL, y = "← Avg. Margin of Defeat | Avg. Margin of Victory →",
       title = "Team Margins of Victory and Defeat", subtitle = "Ordered by Largest to Smallest Range") +
  theme(axis.text.x = element_blank())
```

### One-Run Games

```{r echo = F}
one_runs = end_games |>
  filter(abs(home_score - away_score) == 1) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         home_win = ifelse(win_team == home_team, 1, 0))

or_wins = rename(count(one_runs, win_team), wins = n)
or_losses = rename(count(one_runs, lose_team), losses = n)

or_df = left_join(or_wins, or_losses, by = c("win_team" = "lose_team")) |>
  mutate(gp = wins + losses,
         win_per = round(wins / gp, 3)) |>
  left_join(team_abbrevs, by = c("win_team" = "team"))

or_df |>
  ggplot(aes(gp, win_per)) +
  geom_point(aes(col = win_team), size = 4, show.legend = F) +
  scale_color_manual(values = team_color_codes) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  geom_hline(aes(yintercept = mean(or_df$win_per)), linetype = "dashed", alpha = 0.5) +
  geom_vline(aes(xintercept = mean(or_df$gp)), linetype = "dashed", alpha = 0.5) +
  labs(x = "One-Run Games Played", y = "Win Percentage in One-Run Games",
       title = "How are MLB teams performing in one-run games?")
```

### Yesterday's Highest-Scoring Game

```{r message = F, warning = F, echo = F}
last_game_date = end_games |> slice_max(date, n = 1) |> sample_n(1) |> pull(date)

get_date_pks = function(fdate) {
  df = mlb_game_pks(date = fdate) |>
    select(game_pk, date = officialDate, away_team = teams.away.team.name, home_team = teams.home.team.name) |>
    mutate(date = as_date(date))
  
  return(df)
}

all_game_pks = data.frame(game_pk = NULL, date = NULL, away_team = NULL, home_team = NULL)

for (i in 1:length(loop_dates)) {
  df = get_date_pks(loop_dates[i])
  all_game_pks = rbind(all_game_pks, df)
}

max_home_team = end_games |>
  filter(date == Sys.Date() - 1) |>
  mutate(total_score = home_score + away_score) |>
  slice_max(total_score, n = 1) |>
  pull(home_team)

max_pk = all_game_pks |>
  filter(date == Sys.Date() - 1) |>
  filter(home_team == max_home_team) |>
  pull(game_pk)

vis_df = mlb_pbp(game_pk = max_pk) |>
  filter(count.outs.end == 3) |>
  select(inning = about.inning, away_team, away_score = result.awayScore, home_score = result.homeScore, home_team) |>
  pivot_longer(c(home_score, away_score), names_to = "team", values_to = "score") |>
  mutate(team = ifelse(team == "home_score", home_team, away_team)) |>
  group_by(inning, team) |>
  slice_max(score, n = 1)

max_teams = sort(unique(vis_df$team))
max_colors = c(team_color_codes[which(team_colors$team == max_teams[1])],
               team_color_codes[which(team_colors$team == max_teams[2])])

high_df = end_games |>
  filter(date == Sys.Date() - 1) |>
  mutate(total_score = home_score + away_score,
         win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score)) |>
  slice_max(total_score, n = 1)

high_lab = paste0(high_df$win_team, " def. ", high_df$lose_team, " ", high_df$win_score, "-", high_df$lose_score)

vis_df |>
  ggplot(aes(inning, score)) +
  geom_line(aes(col = team), linewidth = 2) +
  scale_x_continuous(breaks = 1:25) +
  scale_y_continuous(breaks = 1:25) +
  scale_color_manual(values = max_colors) +
  labs(x = "Inning", y = "Score", col = NULL, subtitle = high_lab,
       title = "Scoring Trends for Yesterday's Highest-Scoring Game")
```

### Best Records This Month

```{r echo = F}
this_month = as.character(month(Sys.Date(), label = T, abbr = F))

this_month_end_games = end_games |>
  filter(month(date, label = T, abbr = F) == this_month) |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         win_score = ifelse(home_score > away_score, home_score, away_score),
         lose_score = ifelse(home_score > away_score, away_score, home_score))

this_month_records = this_month_end_games |>
  count(win_team) |>
  rename(team = win_team, wins = n) |>
  full_join(count(this_month_end_games, lose_team), by = c("team" = "lose_team")) |>
  rename(losses = n) |>
  mutate(wins = replace_na(wins, 0),
         losses = replace_na(losses, 0),
         pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(team)

this_month_records |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 1)) +
  labs(x = NULL, y = "Win Percentage", title = paste0("Best Records This Month (", this_month, ")")) +
  theme(axis.text.x = element_blank())
```

### Runs Scored This Month

```{r echo = F}
get_month_rspg = function(team) {
  home_scores = pull(filter(this_month_end_games, home_team == team), home_score)
  away_scores = pull(filter(this_month_end_games, away_team == team), away_score)
  return(sum(c(home_scores, away_scores)))
}

get_month_rapg = function(team) {
  home_scores = pull(filter(this_month_end_games, home_team == team), away_score)
  away_scores = pull(filter(this_month_end_games, away_team == team), home_score)
  return(sum(c(home_scores, away_scores)))
}

this_month_scored_allowed = data.frame(team = all_teams) |>
  mutate(scored = sapply(team, get_month_rspg),
         allowed = sapply(team, get_month_rapg),
         diff = scored - allowed)

this_month_scored_allowed |>
  ggplot(aes(reorder(team, scored), scored)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = scored), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip() +
  labs(x = NULL, y = "Runs Scored", title = paste0("Most Runs Scored This Month (", this_month, ")")) +
  theme(axis.text.x = element_blank())
```

### Runs Allowed This Month

```{r echo = F}
this_month_scored_allowed |>
  ggplot(aes(reorder(team, allowed), allowed)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = allowed), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip() +
  labs(x = NULL, y = "Runs Allowed", title = paste0("Most Runs Allowed This Month (", this_month, ")")) +
  theme(axis.text.x = element_blank())
```

### Best Home Records

```{r echo = F}
end_wl = end_games |>
  mutate(win_team = ifelse(home_score > away_score, home_team, away_team),
         lose_team = ifelse(home_score > away_score, away_team, home_team),
         home_win = ifelse(home_score > away_score, 1, 0),
         home_loss = ifelse(home_score > away_score, 0, 1),
         away_win = ifelse(home_score > away_score, 0, 1),
         away_loss = ifelse(home_score > away_score, 1, 0))

home_away_records = end_wl |>
  group_by(team = home_team) |>
  summarise(wins = sum(home_win),
            losses = sum(home_loss)) |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  arrange(desc(win_pct)) |>
  select(team, home_win_pct = win_pct, home_record = record) |>
  left_join(end_wl |>
          group_by(team = away_team) |>
          summarise(wins = sum(away_win),
                    losses = sum(away_loss)) |>
          mutate(win_pct = round(wins / (wins + losses), 3),
                 record = paste0(wins, "-", losses)) |>
          arrange(desc(win_pct)) |>
          select(team, away_win_pct = win_pct, away_record = record), by = "team")

home_away_records |>
  ggplot(aes(reorder(team, home_win_pct), home_win_pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = home_record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.8)) +
  labs(x = NULL, y = "Home Win Percentage", title = "Best Home Records") +
  theme(axis.text.x = element_blank())
```

### Best Away Records

```{r echo = F}
home_away_records |>
  ggplot(aes(reorder(team, away_win_pct), away_win_pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = away_record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.8)) +
  labs(x = NULL, y = "Away Win Percentage", title = "Best Away Records") +
  theme(axis.text.x = element_blank())
```

### Runs Scored v Runs Allowed This Month

```{r echo = F}
get_n_games_month = function(team) {
  return(end_games |> filter(month(date) == month(Sys.Date()) & (home_team == team | away_team == team)) |> nrow())
}

msas = this_month_scored_allowed |>
  mutate(n_games = sapply(team, get_n_games_month),
         rspg = scored / n_games, rapg = allowed / n_games) |>
  left_join(team_abbrevs, by = "team")

mean_s = mean(msas$rspg)
mean_a = mean(msas$rapg)

msas |>
  ggplot(aes(rspg, rapg)) +
  geom_point(aes(col = team), show.legend = F, size = 4) +
  ggrepel::geom_text_repel(aes(label = abb)) +
  scale_color_manual(values = team_color_codes) +
  geom_vline(xintercept = mean_s, linetype = "dashed", alpha = 0.5) +
  geom_hline(yintercept = mean_a, linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 10, by = 1)) +
  scale_y_continuous(breaks = seq(0, 10, by = 1)) +
  labs(x = "Runs Scored Per Game", y = "Runs Allowed Per Game",
       title = paste0("Scatterplot of Runs Scored v. Runs Allowed This Month (", this_month, ")"),
       subtitle = paste0("League Averages: ", round(mean_s, 2), " Runs Scored / ",
                         round(mean_a, 2), " Runs Allowed"))
```

### What if Games Were Decided by Hits?

```{r message = F, warning = F, echo = F}
end_with_pks = end_games |> left_join(all_game_pks, by = c("date", "home_team", "away_team"))
hit_criteria = c("Single", "Double", "Triple", "Home Run")
bad_pks = c(718700, 718558, 718371, 717664, 717579)

get_pk_hits = function(fpk) {
  f_data = mlb_pbp(fpk) |> filter(details.isInPlay == T & result.event %in% hit_criteria)
  home_team = unique(f_data$home_team)
  return(f_data |> mutate(is_hit = 1) |> group_by(batting_team) |> summarise(n_hits = sum(is_hit)) |>
    mutate(batting_team = ifelse(batting_team == home_team, "home_hits", "away_hits")) |>
    pivot_wider(names_from = "batting_team", values_from = "n_hits") |>
    transmute(game_pk = fpk, home_hits, away_hits))
}

# bind_pk_set = data.frame(game_pk = NULL, home_hits = NULL, away_hits = NULL)
# 
# for (i in 1:length(all_game_pks$game_pk)) {
#   if (all_game_pks$game_pk[i] %in% bad_pks) {
#     print("bad pk")
#     f_data = data.frame(game_pk = all_game_pks$game_pk[i], home_hits = NA, away_hits = NA)
#   } else {
#   f_data = get_pk_hits(all_game_pks$game_pk[i])
#   }
#   bind_pk_set = rbind(bind_pk_set, f_data)
#   if (i %% 25 == 0) print(i)
# }

# write_csv(bind_pk_set, "pk_hits_8_july_2023.csv")
bind_pk_set = read_csv("pk_hits_8_july_2023.csv", col_types = cols())

pk_hits_joined = all_game_pks |>
  left_join(bind_pk_set, by = "game_pk") |>
  filter(date < Sys.Date() & !is.na(home_hits) & !is.na(away_hits)) |>
  mutate(hits_winner = case_when(home_hits > away_hits ~ home_team,
                                 home_hits < away_hits ~ away_team,
                                 home_hits == away_hits ~ "Tie"),
         hits_loser = case_when(home_hits > away_hits ~ away_team,
                                 home_hits < away_hits ~ home_team,
                                 home_hits == away_hits ~ "Tie"))

hits_ties = pk_hits_joined |> filter(hits_winner == "Tie")
hits_non_ties = pk_hits_joined |> filter(hits_winner != "Tie")

hit_records = hits_non_ties |>
  count(hits_winner) |>
  rename(team = hits_winner, hit_wins = n) |>
  left_join(hits_non_ties |>
              count(hits_loser) |>
              rename(team = hits_loser, hit_losses = n), by = "team") |>
  left_join(hits_ties |>
              count(home_team) |>
              rename(team = home_team, home_ties = n), by = "team") |>
  left_join(hits_ties |>
              count(away_team) |>
              rename(team = away_team, away_ties = n), by = "team") |>
  transmute(team, hit_wins, hit_losses, hit_ties = home_ties + away_ties) |>
  mutate(hit_win_pct = round(hit_wins / (hit_wins + hit_losses), 3),
         hit_record = paste0(hit_wins, "-", hit_losses, "-", hit_ties))

hit_records |>
  left_join(team_records, by = "team") |>
  left_join(team_abbrevs, by = "team") |>
  select(abb, win_pct, hit_win_pct) |>
  ggplot(aes(win_pct, hit_win_pct)) +
  geom_point(aes(col = abb), show.legend = F, size = 4) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = team_color_codes) +
  labs(x = "Win Percentage", y = "Win Percentage if Games Were Decided by Hits",
       title = "What if game outcomes were decided by hits instead of runs?",
       subtitle = "Teams above the dashed line would benefit",
       caption = "Win Percentage by Hits Data as of 7 July 2023") +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05))
```

### What if Games Were Decided by Total Bases?

```{r message = F, warning = F, echo = F}
pk_total_bases = function(fpk) {
  f_data = mlb_pbp(fpk) |>
    filter(details.isInPlay == T & result.event %in% c("Single", "Double", "Triple", "Home Run", "Walk"))
  
  home_team = unique(f_data$home_team)
  
  return(f_data |>
    mutate(total_bases = case_when(result.event == "Single" ~ 1,
                                   result.event == "Double" ~ 2,
                                   result.event == "Triple" ~ 3,
                                   result.event == "Home Run" ~ 4)) |>
    group_by(batting_team) |>
    summarise(total_bases = sum(total_bases)) |>
    mutate(batting_team = ifelse(batting_team == home_team, "home_bases", "away_bases")) |>
    pivot_wider(names_from = "batting_team", values_from = "total_bases") |>
    transmute(game_pk = fpk, home_bases, away_bases))
}

pk_list = all_game_pks$game_pk
# bases_df = data.frame(game_pk = NULL, home_bases = NULL, away_bases = NULL)
# 
# for (i in 1:length(pk_list)) {
#   if (pk_list[i] %in% bad_pks) {
#     loop_data = data.frame(game_pk = fpk, home_bases = NA, away_bases = NA)
#   } else {
#     loop_data = pk_total_bases(pk_list[i])
#   }
#   bases_df = rbind(bases_df, loop_data)
#   if (i %% 25 == 0) print(paste0(i, " of ", length(pk_list)))
# }

bases_df = read_csv("bases_8july2023.csv", col_types = cols())

bases_wl = all_game_pks |>
  left_join(bases_df, by = "game_pk") |>
  filter(!is.na(home_bases) & !is.na(away_bases)) |>
  mutate(bases_winner = case_when(home_bases > away_bases ~ home_team,
                                  home_bases < away_bases ~ away_team,
                                  home_bases == away_bases ~ "Tie"),
         bases_loser = case_when(home_bases > away_bases ~ away_team,
                                  home_bases < away_bases ~ home_team,
                                  home_bases == away_bases ~ "Tie"))

bases_ties = bases_wl |> filter(bases_winner == "Tie")
bases_nontie = bases_wl |> filter(bases_winner != "Tie")

bases_records = bases_nontie |>
  count(bases_winner) |>
  rename(team = bases_winner, wins = n) |>
  left_join(bases_nontie |>
  count(bases_loser) |>
  rename(team = bases_loser, losses = n), by = "team") |>
  left_join(bases_ties |>
  count(home_team) |>
  rename(team = home_team, home_ties = n), by = "team") |>
  left_join(bases_ties |>
  count(away_team) |>
  rename(team = away_team, away_ties = n), by = "team") |>
  mutate(home_ties = replace_na(home_ties, 0),
         away_ties = replace_na(away_ties, 0)) |>
  transmute(team, wins, losses, ties = home_ties + away_ties) |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses, "-", ties))

# bases_records |>
#   ggplot(aes(reorder(team, win_pct), win_pct)) +
#   geom_col(aes(fill = team), show.legend = F) +
#   geom_text(aes(label = record), size = 3, hjust = -0.25) +
#   scale_fill_manual(values = team_color_codes) +
#   coord_flip(ylim = c(0, 0.8)) +
#   labs(x = NULL, y = "Win Percentage",
#        title = "Team Records if Games Were Decided by Total Bases",
#        caption = "Data as of 8 July 2023") +
#   theme(axis.text.x = element_blank())

bases_records |>
  select(team, b_win_pct = win_pct) |>
  left_join(team_records, by = "team") |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_pct, b_win_pct)) +
  geom_point(aes(col = abb), show.legend = F, size = 4) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  scale_color_manual(values = team_color_codes) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05)) +
  labs(x = "Win Percentage", y = "Win Percentage if Wins Determined by Total Bases",
       title = "What if game outcomes were decided by total bases instead of runs?",
       subtitle = "Teams above dashed line would benefit",
       caption = "Total Bases Data as of 8 July 2023")
```

### Sudden Death Records

```{r message = F, warning = F, echo = F}
who_scored_first = function(fpk) {
  return(mlb_pbp(fpk) |>
    filter(isPitch & about.isScoringPlay) |>
    mutate(startTime = as_datetime(startTime)) |>
    arrange(startTime) |>
    head(1) |>
    pull(batting_team))
}

# pks_with_scored_first = all_game_pks |>
#   filter(!game_pk %in% bad_pks & date < Sys.Date()) |>
#   mutate(first_score = sapply(game_pk, who_scored_first))

# write_csv(pks_with_scored_first, "first_score_winners_9july2023.csv")
pks_with_scored_first = read_csv("first_score_winners_9july2023.csv", col_types = cols())

scored_first_records = pks_with_scored_first |>
  mutate(loser = ifelse(first_score == home_team, away_team, home_team)) |>
  count(loser) |>
  rename(team = loser, losses = n) |>
  left_join(pks_with_scored_first |>
  count(first_score) |>
  rename(team = first_score, wins = n), by = "team") |>
  select(team, wins, losses) |>
  mutate(win_pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses))

# scored_first_records |>
#   ggplot(aes(reorder(team, win_pct), win_pct)) +
#   geom_col(aes(fill = team), show.legend = F) +
#   geom_text(aes(label = record), size = 3, hjust = -0.25) +
#   scale_fill_manual(values = team_color_codes) +
#   coord_flip(ylim = c(0, 0.75)) +
#   labs(x = NULL, y = "Win Percentage", title = "MLB Rankings if First Score Won") +
#   theme(axis.text.x = element_blank())

scored_first_records |>
  select(team, fs_pct = win_pct) |>
  left_join(team_records, by = "team") |>
  select(team, win_pct, fs_pct) |>
  left_join(team_abbrevs, by = "team") |>
  ggplot(aes(win_pct, fs_pct)) +
  geom_point(aes(col = team), size = 4, show.legend = F) +
  ggrepel::geom_text_repel(aes(label = abb), size = 4) +
  scale_color_manual(values = team_color_codes) +
  geom_abline(linetype = "dashed", alpha = 0.5) +
  labs(x = "Win Percentage", y = "Win Percentage if First Score Won",
       title = "What if MLB games were sudden death?",
       subtitle = "Teams above/left of the dashed line would benefit",
       caption = "First Score Data as of 9 July 2023") +
  scale_x_continuous(breaks = seq(0, 1, by = 0.05)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.05))
```

### Eras Records

```{r echo = F}
eras_dates = as_date(c("2023-03-17", "2023-03-18",
                       "2023-03-24", "2023-03-25",
                       "2023-03-31", "2023-04-01", "2023-04-02",
                       "2023-04-13", "2023-04-14", "2023-04-15",
                       "2023-04-21", "2023-04-22", "2023-04-23",
                       "2023-04-28", "2023-04-29", "2023-04-30",
                       "2023-05-05", "2023-05-06", "2023-05-07",
                       "2023-05-12", "2023-05-13", "2023-05-14",
                       "2023-05-19", "2023-05-20", "2023-05-21",
                       "2023-05-26", "2023-05-27", "2023-05-28",
                       "2023-06-02", "2023-06-03", "2023-06-04",
                       "2023-06-09", "2023-06-10",
                       "2023-06-16", "2023-06-17",
                       "2023-06-23", "2023-06-24",
                       "2023-06-30", "2023-07-01",
                       "2023-07-07", "2023-07-08",
                       "2023-07-14", "2023-07-15",
                       "2023-07-22", "2023-07-23",
                       "2023-07-28", "2023-07-29",
                       "2023-08-03", "2023-08-04", "2023-08-05", "2023-08-06",
                       "2023-08-07", "2023-08-08", "2023-08-09"))

eras_res = end_games |>
  filter(date %in% eras_dates) |>
  mutate(winner = ifelse(home_score > away_score, home_team, away_team),
         loser = ifelse(home_score > away_score, away_team, home_team))

eras_res |>
  count(winner) |>
  rename(team = winner, wins = n) |>
  left_join(eras_res |>
  count(loser) |>
  rename(team = loser, losses = n), by = "team") |>
  mutate(pct = round(wins / (wins + losses), 3),
         record = paste0(wins, "-", losses)) |>
  ggplot(aes(reorder(team, pct), pct)) +
  geom_col(aes(fill = team), show.legend = F) +
  geom_text(aes(label = record), size = 3, hjust = -0.25) +
  scale_fill_manual(values = team_color_codes) +
  coord_flip(ylim = c(0, 0.75)) +
  labs(x = NULL, y = "Win Percentage", title = "MLB Team Records on Eras Tour Dates",
       subtitle = "Which MLB team is the ultimate group of Swifties?") +
  theme(axis.text.x = element_blank())
```




